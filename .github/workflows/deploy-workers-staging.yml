name: Deploy Workers (staging)

on:
  push:
    branches:
      - '**'          # любые ветки
  workflow_dispatch:   # чтобы можно было запускать вручную


concurrency:
  group: deploy-workers-staging-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api-gateway
            path: apps/api-gateway
            url: https://go2asia-api-gateway-staging.fred89059599296.workers.dev
            # Folded style (single-line) to avoid bash treating newlines as separate commands
            extra_vars: >-
              --var AUTH_SERVICE_URL:https://go2asia-auth-service-staging.fred89059599296.workers.dev
              --var CONTENT_SERVICE_URL:https://go2asia-content-service-staging.fred89059599296.workers.dev
              --var POINTS_SERVICE_URL:https://go2asia-points-service-staging.fred89059599296.workers.dev
              --var REFERRAL_SERVICE_URL:https://go2asia-referral-service-staging.fred89059599296.workers.dev
          - service: auth-service
            path: apps/auth-service
            url: https://go2asia-auth-service-staging.fred89059599296.workers.dev
            extra_vars: ""
          - service: content-service
            path: apps/content-service
            url: https://go2asia-content-service-staging.fred89059599296.workers.dev
            extra_vars: >-
              --var POINTS_SERVICE_URL:https://go2asia-points-service-staging.fred89059599296.workers.dev
          - service: points-service
            path: apps/points-service
            url: https://go2asia-points-service-staging.fred89059599296.workers.dev
            extra_vars: ""
          - service: referral-service
            path: apps/referral-service
            url: https://go2asia-referral-service-staging.fred89059599296.workers.dev
            extra_vars: >-
              --var POINTS_SERVICE_URL:https://go2asia-points-service-staging.fred89059599296.workers.dev
          - service: token-service
            path: apps/token-service
            url: https://go2asia-token-service-staging.fred89059599296.workers.dev
            extra_vars: ""

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ ! -d "${{ matrix.path }}" ]; then
            echo "Service directory '${{ matrix.path }}' not found."
            exit 1
          fi

          pnpm --dir "${{ matrix.path }}" exec wrangler deploy --env staging \
            --var ENVIRONMENT:staging \
            --var VERSION:${{ github.sha }} \
            ${{ matrix.extra_vars }}

      - name: Smoke check (HTTP 200)
        run: |
          set -euo pipefail

          URL="${{ matrix.url }}"
          echo "Smoke checking: $URL"

          # Try /health then /version then / (some legacy workers may not have health endpoints yet)
          for path in "/health" "/version" "/"; do
            code="$(curl -sS -o /dev/null -w "%{http_code}" "${URL}${path}" || true)"
            echo "GET ${URL}${path} -> ${code}"
            if [ "${code}" = "200" ]; then
              exit 0
            fi
          done

          echo "Smoke check failed: expected HTTP 200 on ${URL} (/health|/version|/)"
          exit 1



