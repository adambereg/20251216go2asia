# Повторное ревью архитектуры MVP Go2Asia

**Дата:** 2025-01-16  
**Ревьюер:** Architecture Reviewer  
**Документы:**
- `docs/architecture/mvp_architecture.md` (v1.1)
- `docs/architecture/mvp_data_schemas.md` (обновлён)
- `docs/decisions/adr_0010_mvp_synchronous_communication.md` (обновлён)

---

## Summary

Архитектура MVP Go2Asia была успешно исправлена согласно замечаниям первого ревью. Все критические проблемы (BLOCKERS) устранены, все важные замечания (NON-BLOCKERS) учтены. Архитектура готова к использованию Planner для создания плана реализации MVP.

---

## Проверка исправлений

### ✅ BLOCKERS (критические проблемы) — все исправлены

#### ✅ 1. Security: Защита internal endpoints в Cloudflare Workers

**Статус:** RESOLVED

**Проверка:**
- ✅ Убран тезис про "внутреннюю сеть Cloudflare" (раздел 4.3)
- ✅ Добавлен раздел "Service-to-Service Authentication" (раздел 8.2)
- ✅ Описан Service JWT (отдельно от User JWT Clerk)
- ✅ Описаны issuer (`go2asia-service-auth`), claims (`iss`, `aud`, `sub`, `iat`, `exp`, `service_id`), алгоритм (`HS256`)
- ✅ Описана валидация Service JWT с примерами кода
- ✅ Описано хранение секретов в Cloudflare Secrets (`SERVICE_JWT_SECRET`)
- ✅ Описан процесс ротации секретов (5 шагов)
- ✅ Описана защита internal endpoints (требуют Service JWT)

**Замечания:** Нет

---

#### ✅ 2. Data Ownership: Двойная истина для referral_code

**Статус:** RESOLVED

**Проверка:**
- ✅ SSOT определён: Referral Service (`referral.referral_links.code`)
- ✅ Убрано дублирование из `auth.users.referral_code` (проверено в `mvp_data_schemas.md`, строка 45)
- ✅ Добавлено примечание в `mvp_architecture.md` (раздел 3.2): "referral_code НЕ хранится в auth.users"
- ✅ Обновлены Event Flows: Auth Service вызывает Referral Service для генерации referral_code

**Замечания:** Нет

---

#### ✅ 3. Data Ownership: Валидация user_id без внешних ключей

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлен раздел "Стратегия валидации user_id без внешних ключей" (раздел 3.2)
- ✅ Описана стратегия hard validation через Gateway/Clerk JWT
- ✅ Описано, как Gateway передаёт `user_id` в заголовке `X-User-ID`
- ✅ Объявлено, что удаление пользователей НЕ поддерживается в MVP
- ✅ Добавлены комментарии в `mvp_data_schemas.md` о стратегии валидации

**Замечания:** Нет

---

#### ✅ 4. Наблюдаемость: Отсутствие обработки каскадных сбоев

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлен раздел "Обработка каскадных сбоев" (раздел 10.5)
- ✅ Описаны таймауты для межсервисных вызовов (2-3 секунды)
- ✅ Описаны правила retry (0 для не-критических, 1 для критических)
- ✅ Описаны 4 сценария graceful degradation
- ✅ Обновлён ADR 0010 разделом "Митигация рисков синхронной коммуникации"
- ✅ Описаны мониторинг и алерты

**Замечания:** Нет

---

### ✅ NON-BLOCKERS (важные замечания) — все исправлены

#### ✅ 5. Соответствие ТЗ: Points limits и VIP role

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлена таблица правил начисления Points с per-action limits (раздел 2.4)
- ✅ Описаны специфичные лимиты для каждого типа действия (registration: 1 раз, event_registration: 1 раз в день)
- ✅ Общий velocity limit (1000 Points в час) описан как дополнительная защита
- ✅ Описаны VIP коэффициенты: где хранятся (в метаданных запроса), как применяются (коэффициент 1.5 для VIP-Spacer при referral_bonus)
- ✅ Добавлен пример кода применения VIP коэффициента

**Замечания:** Нет

---

#### ✅ 6. Gateway Responsibilities: Где происходит authz

**Статус:** RESOLVED

**Проверка:**
- ✅ Определена стратегия авторизации (раздел 8.3): Gateway проверяет роли, передаёт user_id в сервисы
- ✅ Описан процесс авторизации (6 шагов)
- ✅ Описана защита доверия заголовкам (Gateway — единственный источник `X-User-ID`)
- ✅ Определено, где происходит проверка ролей (Gateway для административных операций)

**Замечания:** 
- ⚠️ Небольшое дублирование: разделы 8.3 и 8.4 повторяются дважды в документе (строки 935-946 и 948-958). Это не критично, но стоит исправить для чистоты документа.

---

#### ✅ 7. Gateway Responsibilities: Кэширование и PWA offline

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлен раздел "Стратегия кэширования" (раздел 9.1)
- ✅ Описано взаимодействие Edge Cache и Service Worker Cache
- ✅ Описаны Cache-Control заголовки для разных типов данных
- ✅ Добавлена таблица кэширования (раздел 9.1.3)
- ✅ Описана стратегия для офлайн-контента (Network First, Cache First)

**Замечания:** Нет

---

#### ✅ 8. Наблюдаемость: requestId сквозной трассировки

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлен раздел "RequestId Propagation" (раздел 10.1)
- ✅ Описан механизм генерации requestId (UUID v4)
- ✅ Описан механизм передачи requestId между сервисами (заголовок `X-Request-ID`)
- ✅ Добавлены примеры кода передачи requestId

**Замечания:** Нет

---

#### ✅ 9. Соответствие ТЗ: Seed данные

**Статус:** RESOLVED

**Проверка:**
- ✅ Добавлен раздел "Seed данные для MVP" (раздел 11)
- ✅ Описан процесс загрузки seed данных (когда, чем, идемпотентность)
- ✅ Описана структура seed файлов
- ✅ Описана команда для загрузки
- ✅ Описана проверка кодировки UTF-8

**Замечания:** Нет

---

## Финальная проверка чек-листа

### ✅ 1. Соответствие ТЗ MVP v1.1

**Статус:** APPROVED

- ✅ Points limits соответствуют ТЗ (per-action + общий velocity)
- ✅ VIP role описана корректно (только коэффициенты, без новых функций)
- ✅ Badges описаны как виртуальные достижения (UI-индикаторы)
- ✅ Seed данные описаны согласно ТЗ

### ✅ 2. Реалистичность security-модели Cloudflare Workers

**Статус:** APPROVED

- ✅ Service JWT описан детально (issuer, claims, валидация)
- ✅ Хранение секретов в Cloudflare Secrets описано
- ✅ Ротация секретов описана
- ✅ Internal endpoints защищены Service JWT (нет упоминания "внутренней сети")

### ✅ 3. Data ownership и отсутствие "двойной истины"

**Статус:** APPROVED

- ✅ referral_code SSOT = Referral Service (убрано дублирование из auth.users)
- ✅ user_id валидация описана (hard validation через Gateway/Clerk JWT)
- ✅ Удаление пользователей не поддерживается в MVP

### ✅ 4. Gateway responsibilities

**Статус:** APPROVED

- ✅ Authz определён (Gateway проверяет роли, передаёт user_id)
- ✅ Кэширование описано (Edge cache + Service Worker cache)
- ✅ Cache-Control заголовки описаны
- ✅ Соответствие PWA offline стратегии

### ✅ 5. Наблюдаемость

**Статус:** APPROVED

- ✅ RequestId propagation описана
- ✅ Обработка каскадных сбоев описана (таймауты, retry, graceful degradation)
- ✅ Логирование структурировано

---

## Minor Issues (не блокирующие)

### ⚠️ Дублирование разделов

**Проблема:** Разделы 8.3 и 8.4 повторяются дважды в документе (строки 935-946 и 948-958).

**Рекомендация:** Удалить дублирование для чистоты документа. Это не критично для функциональности.

---

## Verdict

**Статус:** **APPROVED**

**Обоснование:**

Архитектура MVP Go2Asia успешно исправлена согласно всем замечаниям первого ревью. Все критические проблемы (BLOCKERS) устранены, все важные замечания (NON-BLOCKERS) учтены. Архитектура:

1. ✅ Реалистична для Cloudflare Workers (Service JWT вместо "внутренней сети")
2. ✅ Имеет чёткое data ownership (SSOT определён для всех данных)
3. ✅ Имеет стратегию валидации user_id без FK
4. ✅ Имеет обработку каскадных сбоев (таймауты, retry, graceful degradation)
5. ✅ Соответствует ТЗ MVP v1.1 (Points limits, VIP role, badges, seed data)
6. ✅ Имеет чёткие Gateway responsibilities (authz, кэширование)
7. ✅ Имеет наблюдаемость (requestId propagation, логирование, метрики)

**Рекомендуемые действия:**

1. ✅ Архитектура может быть передана Planner для создания плана реализации MVP
2. ⚠️ Опционально: Исправить дублирование разделов 8.3 и 8.4 (не критично)

---

## Deliverables

- ✅ Повторное ревью архитектуры MVP проведено
- ✅ Все BLOCKERS проверены и исправлены
- ✅ Все NON-BLOCKERS проверены и исправлены
- ✅ Вердикт выдан: APPROVED

## Open Questions

Нет открытых вопросов. Все архитектурные решения приняты и задокументированы.

## Next

Архитектура MVP готова к передаче **Planner** для создания плана реализации MVP. После создания плана должен быть запущен **Planning Reviewer** для проверки плана.

