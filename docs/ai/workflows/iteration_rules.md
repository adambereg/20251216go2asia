# Go2Asia — Iteration Rules  
Правила итераций мультиагентной разработки

Этот документ описывает, **как именно должны выполняться повторные циклы (итерации)** на каждом этапе пайплайна:

- чтобы не превращать процесс в хаос,
- чтобы не «переписывать всё с нуля»,
- чтобы уважать связи ТЗ → Архитектура → План → Реализация,
- чтобы правильно использовать review-пайплайн.

Итерации управляются **Оркестратором** и всегда опираются на `pipeline_overview.md` и `review_pipeline.md`.

---

## 1. Общие принципы итераций

1. **Итерация — не стирание истории.**  
   Каждая итерация должна дополнять и уточнять существующие артефакты, а не заменять их без объяснения причин.

2. **Итерация запускается только при наличии конкретной причины:**
   - найдено противоречие,
   - не выполнен критерий приёмки,
   - review-режим вернул замечания,
   - downstream-этап обнаружил, что upstream-артефакт некорректен.

3. **Итерациями управляет Оркестратор.**  
   Ни один агент не должен самодовольно «начать всё заново». Он обязан:
   - зафиксировать проблему,
   - предложить объём изменений,
   - дождаться решения Оркестратора.

4. **Каждая итерация должна быть ограничена по объёму.**  
   Нельзя «переписать всё» без крайней необходимости.  

5. **Любая существенная итерация = след в документации.**  
   - комментарий к ТЗ / архитектуре / плану,
   - новая запись ревью или обновление старой,
   - при необходимости — новый ADR.

---

## 2. Связь итераций с пайплайном

Порядок этапов см. в `pipeline_overview.md`:

1. Анализ требований (ТЗ)
2. Архитектура
3. Планирование
4. Инфраструктура (DevOps)
5. Разработка (FE/BE)
6. Тестирование (QA)
7. Security Review
8. Документация
9. Релиз

**Итерации могут:**

- происходить **внутри одного этапа** (локальная итерация),
- инициировать **возврат на предыдущий этап** (feedback-цикл: Dev → Архитектура, QA → Dev и т.д.).

При этом действует правило:

> Чем выше уровень (ТЗ/Архитектура/План), тем дороже итерация и тем строже к ней относятся.

---

## 3. Итерации по ролям

### 3.1. Requirements Analyst (ИИ-аналитик)

**Когда допускаются итерации ТЗ:**

- review-режим (TЗ-review) вернул критические замечания;
- архитектор обнаружил, что часть требований противоречива или неформализована;
- планировщик не может построить реалистичный план;
- пользователь существенно изменил требования;
- downstream-этап обнаружил, что ТЗ не покрывает важный сценарий.

**Ограничения:**

- не более **3 крупных итераций** по одному ТЗ без ADR-решения;
- при 3-й итерации Оркестратор должен либо:
  - зафиксировать компромиссное решение,
  - либо инициировать ADR «Изменение требований» с описанием trade-off.

**Требования к каждой итерации:**

- сохранить предыдущую версию (или зафиксировать изменения в комментарии);
- явно перечислить, *что именно* изменено и почему;
- обновить критерии приёмки, если они меняются.

---

### 3.2. Architect (ИИ-архитектор)

**Основания для архитектурной итерации:**

- изменилось ТЗ (легитимным образом);
- Architecture-review вернул существенные замечания;
- планировщик показал, что реализация слишком сложна или не реализуема в рамках текущих ограничений;
- Dev/QA/Security обнаружили фундаментальную проблему (масштабируемость, безопасность, неконсистентность);
- появился новый ADR, влияющий на архитектуру.

**Ограничения:**

- до **2 полных пересмотров архитектуры** на один модуль/сервис без отдельного ADR;
- при третьей серьёзной итерации:
  - обязательно создаётся ADR: `adr_XXXX_architecture_change_<topic>.md`,
  - в нём фиксируется причина и новая версия решения.

**Формат итерации:**

- изменённый документ архитектуры помечается версионно (дата/версия в шапке);
- в review-файле (`docs/reviews/architecture/`) фиксируются:
  - что было не так,
  - чем новая версия лучше,
  - какие риски остаются.

---

### 3.3. Planner (ИИ-планировщик)

**Когда план пересматривается:**

- поменялось ТЗ или архитектура;
- выявлены крупные зависимости, которых не было видно раньше;
- в ходе разработки стало ясно, что оценка сроков/объёмов нереалистична;
- Оркестратор решает сдвинуть приоритеты между фазами/спринтами.

**Ограничения:**

- не более **2 крупных пересборок плана** на фазу;
- мелкие уточнения (разбивка задач, улучшение описаний) разрешены без ограничений, но:
  - должны быть отражены в план-файле,
  - при крупных изменениях — обязательно обновляется Plan-review.

**Правило консистентности:**

- План всегда должен ссылаться на актуальные версии:
  - ТЗ,
  - архитектуры,
  - ADR.

---

### 3.4. DevOps (ИИ-DevOps-инженер)

**Итерации инфраструктуры:**

- допустимы, если:
  - меняется архитектура микросервисов,
  - меняется strategия деплоя (preview/staging/prod),
  - появляется новый сервис,
  - добавляются новые внешние интеграции.

**Важно:**

- если инфраструктурная итерация затрагивает **границы микросервисов** или **способ их взаимодействия**,  
  Оркестратор обязан:
  - инициировать Architecture-review,
  - при необходимости — новый ADR.

---

### 3.5. Backend / Frontend Dev (ИИ-разработчики)

**Разработка — самый итеративный этап.**

Допускаются многократные итерации кода, но:

1. **Нельзя бесконечно «выбрасывать и переписывать всё с нуля».**  
   Полный рефакторинг допустим только:
   - по согласованию с Архитектором,
   - с фиксацией причины (например, отдельный ADR).

2. **Максимум 3 «крупные» итерации на один функциональный блок** без эскалации:
   - крупная итерация = переделка архитектуры модуля, контракта, структуры данных;
   - мелкие исправления (фикс багов, поправка стилей, уточнение валидации) не ограничиваются.

3. **Каждый крупный шаг → Code-review + обновление документации.**

**Когда обязательно возвращаться на предыдущие уровни:**

- если реализация невозможна без изменения контракта API → возврат к Архитектору;
- если контент/бизнес-требования не покрываются текущим ТЗ → возврат к Аналитику.

---

### 3.6. QA (ИИ-тестировщик)

**QA-итерации — цикл по умолчанию:**

Dev → QA → Dev → QA → ...


Разрешается количество итераций **до полного прохождения автотестов и критических сценариев**.

QA обязан:

- фиксировать найденные баги в виде списка;
- группировать баги по важности:
  - Blocker,
  - Critical,
  - Major,
  - Minor,
- после исправлений проверять только затронутые области + базовый регресс.

---

### 3.7. Security (ИИ-специалист по безопасности)

**Security-итерации обязательны, если:**

- меняется логика аутентификации / авторизации,
- добавляются новые сервисы,
- меняется токеномика / работа с балансами / финансовые операции,
- модифицируются внешние интеграции (оплата, кошельки, блокчейн).

Количество итераций не ограничено, пока:

- есть невыправленные критические проблемы,
- нарушены базовые требования безопасности.

---

## 4. Типы итераций

### 4.1. Локальная итерация
- происходит **в пределах одного этапа** (например, переработка ТЗ без изменения архитектуры);
- не меняет upstream-артефакты (или меняет их минимально);
- инициируется обычно результатами review-режима.

### 4.2. Feedback-итерация (возврат на upstream-этап)

Примеры:

- Dev обнаружил, что контракт API не жизнеспособен → возврат к Архитектору;
- QA обнаружил, что сценарий не описан в ТЗ → возврат к Аналитику;
- Security выявил уязвимость из-за архитектурной ошибки → возврат к Архитектору.

**В таких случаях Оркестратор:**

1. фиксирует проблему и её тип (ТЗ, Архитектура, План);
2. инициирует соответствующую итерацию;
3. после обновления upstream-артефактов:
   - проверяет, требуется ли обновление плана,
   - контролирует синхронизацию всех артефактов,
   - инициирует повторный review.

---

## 5. Итерации и review-пайплайн

Итерации **жёстко связаны** с `review_pipeline.md`:

- если ревью-режим возвращает замечания, **итерация обязательна**;
- если ревью одобрено, повторная итерация возможна только при серьёзной новой причине.

Правило:

> Без review-результата итерацию нельзя считать завершённой.

Каждая существенная итерация ТЗ / архитектуры / плана / кода должна:

- иметь свой след в `docs/reviews/...`,
- при необходимости — быть отражена в ADR.

---

## 6. Ограничения против «вечной разработки»

Чтобы не уйти в бесконечный рефакторинг, действуют следующие правила:

1. **Лимиты итераций по верхним уровням:**
   - ТЗ: ≤ 3 крупных итерации, далее ADR;
   - Архитектура: ≤ 2 крупных пересмотра, далее ADR;
   - План: ≤ 2 крупных пересборки на фазу.

2. **Флаг “заморозки уровня”:**
   - когда фаза/модуль входит в активную разработку,
   - ТЗ и архитектура считаются «замороженными»,
   - изменения возможны только через:
     - Оркестратора,
     - отдельный ADR,
     - обновление плана.

3. **Definition of Done (DoD):**
   - задача/этап считается завершённым только если:
     - ревью прошло,
     - документация обновлена,
     - ADR (если нужен) создан,
     - тесты зелёные.

---

## 7. Роль Оркестратора в управлении итерациями

Оркестратор обязан:

1. Отслеживать **все итерации** по крупным артефактам.
2. При повторяющихся итерациях:
   - определять «узкое место» (ТЗ, архитектура, план, код),
   - инициировать анализ причин (root cause).
3. При необходимости:
   - инициировать ADR о пересмотре подхода,
   - менять приоритеты фаз/спринтов,
   - ограничивать масштаб очередной итерации.

Оркестратор — единственный «хранитель здравого смысла» в итерациях.

---

## 8. Резюме

- Итерации допустимы и ожидаемы — это нормальная часть процесса.
- Но каждая итерация должна:
  - иметь причину,
  - быть ограничена по масштабу,
  - оставлять след в документации,
  - проходить через review-пайплайн,
  - управляться Оркестратором.

Следование этим правилам позволяет мультиагентной системе развиваться быстро, но без потери контроля и консистентности.
