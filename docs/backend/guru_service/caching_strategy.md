# Guru Service — Стратегия кеширования

## Задачи кеша

- Уменьшить количество запросов к Atlas/Pulse/Rielt/RF/Quest.
- Ускорить ответы `/nearby`, особенно при схожих запросах.

## Подход

### 1. Гео-тайлы

- Делим поверхность на тайлы (например, по 0.01° широты/долготы).
- Ключ кеша:
  - `nearby:{types_hash}:{tile_lat}:{tile_lng}:{radius}:{time_window}:{rf_only}:{open_now}:{tags_hash}`
- TTL:
  - 30–120 секунд (для динамичных сущностей),
  - 5–10 минут для менее чувствительных комбинаций.

### 2. Пресеты `what-to-do`

- Кеш по ключу вида:
  - `what-to-do:{preset}:{city_id or tile}:{time_slot}`.
- TTL:
  - 5–15 минут.

### 3. Preferences

- `GuruUserPreferences` можно кешировать в Redis по `user_id`:
  - TTL: 5–30 минут,
  - обновление при `PUT /preferences/me`.

## Инвалидирование

- Мягкая стратегия:
  - TTL истекает, и кеш пересобирается по запросу.
- Жёсткая (на следующих этапах):
  - слушать события от Atlas/Pulse/Rielt/RF/Quest (обновление/создание/удаление),
  - инвалидировать тайлы, в которые попадает обновлённый объект.

## Ограничения

- Не кешировать слишком “уникальные” запросы:
  - огромные радиусы,
  - сложные наборы тегов,
  - редкие комбинации типов.
- Можно ограничить число одновременно хранимых ключей по namespace (LRU). 
