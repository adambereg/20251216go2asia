# Atlas Service — Search & Filtering Strategy

## Типы поиска

1. **Структурный поиск**
   - фильтрация по:
     - `country_id`, `city_id`, `district_id`;
     - `type` (категория места);
     - `tags`;
     - `rf_badge`.
   - Используется в Atlas UI, RF-кабинетах, Rielt.

2. **Поиск по радиусу (geo-near / nearby)**
   - вход: `lat`, `lng`, `radius`;
   - используется в Guru Service и для «мест рядом».

3. **Поиск по строке (full-text search)**
   - по полям:
     - `name`;
     - `slug`;
     - alias/alt-имена (если есть);
     - возможно, короткое описание.
   - для автодополнения и поиск места по имени/адресу.

## Фильтры

Поддерживаемые фильтры (минимальный набор):

- Локация:
  - `country_id`,
  - `city_id`,
  - `district_id`,
  - `lat/lng + radius`.

- Тип:
  - `type` (один или несколько кодов категорий).

- Теги:
  - `tags` (и/или `tags_any`, `tags_all`).

- Статус:
  - `status = active/published`.

- RF:
  - `rf_only = true` (только RF-места).

- Сортировка:
  - `sort=distance` (при наличии координат),
  - `sort=rating`,
  - `sort=popularity` (по просмотрам/реакциям, если есть).

## Индексация и технологии

### Минимальный уровень (MVP)

- Индексы в БД:
  - B-tree по `city_id`, `type`,
  - GIN по `tags`,
  - GiST/Sp-GiST по координатам (PostGIS).
- Full-text поиск:
  - по `name` и `description_short` средствами Postgres (tsvector).
- Гео-поиск:
  - PostGIS `ST_DWithin` для поиска по радиусу.

### Расширенный уровень

- Вынос полнотекстового поиска в специализированный движок:
  - Meilisearch / OpenSearch / Elastic.
- Индексирование:
  - отдельный индекс для `places`;
  - хранение:
    - названий,
    - описаний,
    - тегов,
    - базовых геоданных (для pre-filtering).

## Nearby для Guru

Для эндпоинта `GET /places/nearby`:

- обязательные параметры: `lat`, `lng`;
- дополнительные:
  - `radius` (по умолчанию, например, 1500 м);
  - `type` / `tags`;
  - `rf_only`.

Алгоритм:

1. Нормализация входных координат (проверка валидности).
2. Поиск в БД (PostGIS) по радиусу.
3. Применение дополнительных фильтров (`type`, `tags`, `rf_only`).
4. Сортировка по расстоянию (и, опционально, по популярности).
5. Опциональный кеш по гео-тайлам.

## Автодополнение (autocomplete)

Для UX:

- Эндпоинт:
  - `GET /places/autocomplete?q=...&city_id=...`.
- Возвращаем:
  - до N подсказок по `name`, `slug`, alias;
  - тип и город для контекста.

Можно реализовать:

- на основе full-text функции, либо;
- на базе внешнего search-сервиса.

## Ограничения и защита

- Ограничение `limit` / `page_size` (по умолчанию 20–50).
- Rate limiting для публичных поисковых эндпоинтов.
- Защита от слишком больших радиусов (например, максимум 50 км).
