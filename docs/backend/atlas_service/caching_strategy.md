# Atlas Service — Caching Strategy

## Общие принципы

- Основная нагрузка на Atlas — **чтение**.
- Кеш нужен для:
  - ускорения типовых запросов;
  - уменьшения нагрузки на БД;
  - поддержания устойчивости для Guru, Pulse, Rielt и др.

## Уровни кеша

1. **API Gateway / Edge Cache**
   - статические списки:
     - страны, города;
     - популярные места.
   - TTL: от минут до часов, в зависимости от динамики.

2. **Service-Level Cache (внутри Atlas)**
   - Redis / in-memory:
     - `GET /countries`, `GET /cities?country_id=VN` и т.п.;
     - `GET /places/{id}` (горячие места);
     - результаты `nearby` по «плиткам».

3. **Client Cache (на стороне фронтенда)**
   - кеширование списков городов и стран в браузере/приложении;
   - оптимизация запросов за счёт повторного использования данных.

## Что кешируем

- **Справочники:**
  - Countries,
  - Cities,
  - Categories,
  - Tags.

- **Детали места:**
  - `GET /places/{id}` — особенно для популярных мест.

- **Nearby-выдача:**
  - Разбиение карты на тайлы (например, гео-«квадраты»).
  - Кеш результата для тайла + набора фильтров (тип, rf_only).

## Инвалидация

- При изменении сущности (создание, обновление, публикация):
  - сбрасываем:
    - кеш по конкретному Place;
    - кеш связанных тайлов (если используется гео-кеш);
    - при необходимости — списки городов/мест (если затронута структура).

- При изменении RF-статуса:
  - сбрасываем кеш Place;
  - при необходимости оповещаем Guru (через событие).

## TTL

Варианты (примерные):

- Countries/Cities — 1–24 часа (меняются редко).
- Place details — 1–5 минут (возможны частые просмотры).
- Nearby-выдача — 30–120 секунд (компромисс между актуальностью и производительностью).

## Деградация

- При недоступности Redis:
  - сервис продолжает работать без кеша, опираясь только на БД;
  - возможен рост латентности, но функциональность сохраняется.

## Дополнительно

- Для публичного (read-only) Atlas API, используемого внешними интеграциями:
  - можно применить TTL-кеш на уровне CDN или API Gateway.
- Для internal API Atlas ↔ внутренние сервисы:
  - кеширование возможно в вызывающем сервисе (например, Pulse может кешировать `place_id → название` локально).
