# Atlas Service — Архитектура

## Общие принципы

- Отдельный микросервис в составе Go2Asia backend. :contentReference[oaicite:8]{index=8}  
- Синхронное взаимодействие с другими сервисами через REST API.
- Возможна публикация событий в Event Bus (Kafka/NATS/Cloud Pub/Sub и т.п.).
- Atlas — **source of truth** для геоданных.

## Слои сервиса

1. **API Layer (HTTP Controllers)**
   - REST эндпоинты `/api/atlas/v1/...`;
   - валидация входных параметров;
   - маппинг DTO ↔ доменные модели.

2. **Application / Service Layer**
   - кейсы: `CreatePlace`, `UpdatePlace`, `SearchPlaces`, `FindNearbyPlaces`, `PublishPlace`;
   - инкапсулирует бизнес-правила (статусы, роли, RF-логика).

3. **Domain Layer**
   - модели: `Country`, `City`, `District`, `Place`, `PlaceCategory`, `Tag`, `PlaceMedia`;
   - доменные сервисы для:
     - управления иерархией,
     - вычисления границ города для поиска,
     - подсчёта агрегатов (рейтинг, отзывы).

4. **Persistence Layer**
   - ORM/SQL-абстракция (например, Postgres + гео-расширения);
   - репозитории для каждой сущности;
   - индексы по (city_id, type, tags, coordinates).

5. **Integration Layer**
   - клиенты к:
     - RF Service (для RF-заведений),
     - Token/Connect (в будущем, если нужны награды редакторам),
     - Search/Indexing Service (возможная отдельная служба поиска),
     - Event Bus (публикация событий).

6. **Caching Layer**
   - Redis/ин-memory для:
     - списков стран/городов;
     - популярных мест;
     - результатов `nearby` (плиточное кеширование).

## Хранение данных

Рекомендуется использовать:

- реляционную БД (Postgres) с:
  - нормализованной моделью стран/городов/мест;
  - PostGIS для гео-запросов (поиск по радиусу).
- Дополнительно (по мере роста):
  - внешнюю поисковую систему (OpenSearch/Meilisearch) для полнотекстового поиска и сложной фильтрации.

## Масштабирование

- Горизонтальное масштабирование по запросам чтения (большинство операций — read).
- Write-операции относительно редкие (редакция + проверенная UGC).
- Возможное разделение:
  - read-only реплики БД;
  - отдельных воркеров для:
    - пересборки поискового индекса;
    - обработки UGC пачками.

## Отказоустойчивость и деградация

- При недоступности Atlas:
  - Guru может временно использовать кеш последних ответов;
  - Pulse/Rielt могут ограничиться локальными копиями имен городов/мест (если есть).
- Внутренние клиенты должны быть готовы к:
  - HTTP 5xx;
  - таймаутам;
  - пустым результатам при запросах к Atlas.

## Локализация

- Поддержка мультиязычности через:
  - таблицы переводов для названий и описаний,
  - или JSON-локализацию (`name: { "ru": "...", "en": "..." }`).
- UI может запрашивать нужный язык через параметр `lang`.

## Логирование и метрики

- Логирование запросов (уровень `info`) с `correlation-id`.
- Метрики:
  - RPS;
  - среднее время ответа;
  - доля кеш-хитов;
  - число опубликованных мест по странам/городам.
