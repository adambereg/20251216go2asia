# Atlas Service — Validation Rules

## Общие правила

- Все write-операции (создание/обновление мест) требуют:
  - авторизованного пользователя с соответствующей ролью;
  - базовой валидации данных;
  - дополнительной логики для UGC.

## Валидация стран и городов

### Country

- `iso_code` — обязателен и уникален.
- `name` — обязателен.
- `slug` — обязателен, уникален в рамках всего Atlas.

### City

- `country_id` — обязателен, должен существовать.
- `name` и `slug` — обязательны, slug уникален в рамках страны.
- `center_lat`/`center_lng` — внутри допустимых диапазонов координат.

## Валидация мест (Place)

Обязательные поля:

- `city_id` — должен существовать;
- `name` — не пустое;
- `type` — валидный `PlaceCategory.code`;
- `latitude`, `longitude` — корректные координаты;
- `status` — одно из `draft`, `pending_review`, `published`, `archived`.

Дополнительные правила:

- Длина `name` — разумный диапазон (например, 2–200 символов).
- `description_short` — до X символов (для превью).
- `description_full` — может быть длиннее, но с лимитом (например, до 10–20k символов).
- `tags` — только из справочника Tag (`code` валиден).
- Если `rf_badge = true`:
  - должен быть заполнен `rf_place_id` (или наоборот, RF управляет этим полем через internal API).

## Координаты

- `latitude` ∈ [-90, 90];
- `longitude` ∈ [-180, 180].
- Валидация проводится на application уровне (и возможно — на уровне БД/PostGIS).

## Статусы и переходы

- Допустимые переходы:
  - `draft` → `pending_review`;
  - `pending_review` → `published` / `archived`;
  - `published` → `archived` / (ограниченно) `pending_review` (для крупных правок);
- Нельзя:
  - дать UGC-автору напрямую публиковать (`pending_review` → `published` только редакцией);
  - переводить `archived` обратно в `published` без дополнительной проверки/логики.

## Уровни доступа

- `atlas_editor` / `admin`:
  - могут создавать, редактировать, публиковать любые места.
- `ugc_pro` (PRO-пользователь):
  - может создавать черновики мест;
  - обновлять только свои черновики до отправки на модерацию;
  - не может публиковать напрямую.
- Обычный пользователь:
  - либо не имеет прав создавать места;
  - либо может предлагать через отдельный UGC-поток (на усмотрение продукта).

## Валидация связей

При сохранении `Place`:

- `city_id` должен существовать и быть `status = active`.
- `district_id` (если есть) — должен принадлежать выбранному `city_id`.
- Если `rf_place_id` задан:
  - должна существовать запись в RF Service (проверяется через internal API либо отложенно).

## Проверки при удалении/архивировании

При переводе места в `archived`:

- нужно учитывать связанные сущности:
  - события Pulse;
  - квесты;
  - RF-информацию;
  - объявления Rielt.
- В большинстве случаев **жёсткое удаление запрещено**, вместо этого:
  - выставляется `status = archived`;
  - внешний мир понимает, что место «закрыто» и не должно появляться в выдаче (кроме архивных/исторических сценариев).
