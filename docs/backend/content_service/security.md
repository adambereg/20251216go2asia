# Content Service — Security

## Аутентификация

- Все операции изменения контента (POST/PATCH/DELETE) требуют:
  - JWT-токен от User Service (`Authorization: Bearer ...`).
- Публичные GET:
  - `/feed/context` (для гостя) — разрешены без токена,
  - `/posts/{id}` — может быть доступен публично, если пост `visibility = public`.

## Авторизация

- Роли:
  - базовый пользователь — может создавать/редактировать/удалять только свой контент,
  - `moderator` / `admin` — может скрывать/удалять контент других пользователей, обрабатывать жалобы.
- Определяются по claim `role` в access-token.

## Модерация и безопасный контент

- Любой контент может быть помечен `hidden_by_moderator`.
- При отображении:
  - фронт/клиент не должен показывать скрытые/удалённые посты и комментарии.
- Жалобы (`ContentReport`) используются для триггера модерации.

## XSS и форматирование

- `body_format = markdown`:
  - необходимо безопасное преобразование в HTML на фронтенде или в Edge-сервисе:
    - экранирование HTML,
    - whitelist допустимых тэгов (если будет rich-текст).
- Raw HTML в базе не должно доверяться напрямую.

## PII и логи

- В логах:
  - не пишем целиком текст постов/комментариев (или минимизируем),
  - не логируем JWT и чувствительные данные.
- Для дебага:
  - используем correlation-id, `user_id`, `post_id`.

## Rate limiting

- Ограничиваем количество запросов:
  - на создание постов/комментариев,
  - на жалобы.
- Снижаем риск спама/флуд-атак.

## Интеграции

- Internal API (`/internal/...`) защищаются:
  - сервисным JWT,
  - и/или mTLS, IP allow-list.

