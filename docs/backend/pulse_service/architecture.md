# Pulse Service — Архитектура

## Общее положение в экосистеме

Pulse Service — контентный микросервис, отвечающий за события. Он:

- использует Atlas как источник геоданных (страны/города/места);
- обслуживает фронтенд-модуль Pulse Asia;
- интегрируется с Guru, Space, Blog, Quest, Connect, Notification.

## Слои сервиса

1. **API Layer (HTTP Controllers)**
   - REST эндпоинты `/api/pulse/v1/...`;
   - валидация входных данных (query/body);
   - маппинг DTO ↔ доменные сущности.

2. **Application / Service Layer**
   - кейсы:
     - `CreateEvent`
     - `UpdateEvent`
     - `PublishEvent`
     - `CancelEvent`
     - `SearchEvents`
     - `ListNearbyEvents`
   - реализация бизнес-правил:
     - статусы событий;
     - ограничения по ролям;
     - проверка временных интервалов.

3. **Domain Layer**
   - доменные модели:
     - `Event`
     - `EventCategory`
     - `EventTag`
   - логика:
     - определение статуса (upcoming/past/finished);
     - вычисление доступности события (например, скрытие отменённых);
     - поддержка флагов `rf_badge`, `featured`.

4. **Persistence Layer**
   - база данных (Postgres):
     - нормализованная модель `events`, `event_categories`, `event_tags`;
     - индексы по времени и гео-привязке;
   - ORM (Drizzle/Prisma) для удобства миграций.

5. **Integration Layer**
   - HTTP клиенты к:
     - Atlas Service (валидация `place_id`, получение координат/адреса);
     - User Service (проверка ролей организаторов);
     - RF Service (проверка партнёров);
     - Connect/Token Service (в будущем — события активности PRO);
     - Notification Service (email/push про события).
   - Event Bus клиент:
     - публикация `pulse.event_*` событий.

6. **Caching Layer**
   - Redis/ин-memory:
     - популярные события по городам;
     - "срез" событий на выходные;
     - результаты `nearby` по гео-тайлам (Фаза 2).

## Хранение данных и время

- Все временные поля — `timestamp with timezone`.
- Сервис хранит оригинальное время в таймзоне события (`timezone`) и может выдавать в UTC/локальной в зависимости от фронта.
- Фоновый процесс (cron/worker) периодически:
  - помечает события как `finished` по `ends_at`;
  - чистит старые кеши.

## Масштабирование

- Профиль нагрузки — **read-heavy** (списки событий, афиши).
- Записи (create/update/publish/cancel) — относительно редкие.
- Масштабирование:
  - горизонтальное (несколько инстансов сервиса);
  - реплики БД для чтения (опционально);
  - вынос полнотекстового поиска в специализированный движок (Meilisearch/OpenSearch) при росте.

## Надёжность и безопасность

- mTLS и ограничение прав на межсервисные вызовы.
- Обязательная проверка JWT для всех небезопасных операций.
- Логирование запросов с `correlation-id` (через Logging Service).
- Механизм graceful degradation — при недоступности внешних сервисов:
  - Pulse продолжает отдавать данные из своей БД;
  - некоторые интеграции (например, токеномика) могут выполняться асинхронно позже.
