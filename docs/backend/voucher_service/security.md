# Voucher Service — Security

## Аутентификация

- Все пользовательские/админские операции (кроме, возможно, чистого `validate` по коду) требуют:
  - `Authorization: Bearer {access_token}` от User Service.
- Для internal-сервисных вызовов:
  - может использоваться сервисный JWT или mTLS (по мере усложнения инфраструктуры).

## Авторизация и роли

- `user`:
  - может:
    - просматривать свои ваучеры (`/my/vouchers`),
    - валидировать код в своём контексте,
    - вызывать `redeem` для своих операций,
    - смотреть историю (`/my/redemptions`).
- `partner`:
  - может:
    - создавать/обновлять ваучеры, связанные с его кампанией/партнёрством (ограничения задаются на уровне бизнес-логики),
    - смотреть статистику по своим ваучерам.
- `admin`:
  - полный доступ:
    - создание/редактирование любых ваучеров,
    - просмотр всех погашений,
    - смена статусов.

Проверка:

- По `role` claim в токене.
- Дополнительно, для `partner` — проверка привязки к конкретному `partner_id` (в RF Service или отдельном Partner Service).

---

## Безопасность промокодов

- `code` должен быть:
  - достаточно случайным/длинным для приватных/одноразовых ваучеров,
  - допускаются “маркетинговые” короткие коды для публичных кампаний (например, `WELCOME10`).
- Злоупотребление:
  - возможен брутфорс кодов → необходимо:
    - rate limiting по IP/user,
    - безопасная обработка `validate` (не раскрывать лишнюю информацию о существовании кодов).

---

## PII и логирование

- В логи:
  - не писать полные номера телефонов/email,
  - не писать full JWT.
- Логировать:
  - `user_id`,
  - `voucher_id`,
  - тип/результат операции (`validate`, `redeem`),
  - `target_entity_id` (если не содержит PII).

---

## Rate limiting

- Ограничить:
  - частоту `validate` по одному пользователю/IP (anti-bruteforce),
  - частоту `redeem` (anti-spam / защита от нагрузочных атак).

---

## Транспорт

- Внешние запросы — только HTTPS.
- Internal-вызовы — внутри защищённой сети/через mTLS.

