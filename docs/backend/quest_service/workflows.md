# Quest Service — Workflows

## 1. Создание и публикация квеста PRO-спейсером

1. PRO открывает интерфейс создания квеста.
2. Вызывает `POST /quests` — создаётся квест в статусе `draft` или `pending_review`.
3. Добавляет/редактирует шаги через `PUT /quests/{id}/steps`.
4. Отправляет квест на модерацию / публикацию:
   - `POST /quests/{id}/publish` (доступно PRO, но может ставить статус `pending_review`).
5. Admin проверяет:
   - при необходимости правит,
   - публикует (статус `published`).

---

## 2. Покупка квеста VIP-спейсером

1. Пользователь (VIP) выбирает квест в каталоге.
2. Фронтенд/Points Service:
   - проверяет сумму Points,
   - инициирует списание.
3. После успешного списания:
   - вызывается `POST /runs` в Quest Service,
   - создаётся `QuestRun` со статусом `active`.

---

## 3. Прохождение чекпоинтов

1. Пользователь видит список шагов и прогресс.
2. Для каждого шага:
   - выполняет действие (GPS/фото/QR/quiz),
   - отправляет данные через соответствующий endpoint `submit-*`.
3. Quest Service:
   - проверяет условия,
   - обновляет `QuestCheckpointProgress` (auto_verified / awaiting_review).

---

## 4. Публикация отчёта в Space Asia

1. Пользователь завершает все обязательные шаги.
2. В Space создаёт пост в нужной группе (`space_group_id`).
3. В UI квеста:
   - нажимает “Привязать пост” → `POST /runs/{run_id}/attach-space-post`.
4. PRO/модератор:
   - просматривает пост и прогресс,
   - одобряет через `/admin/runs/{run_id}/approve-space-post`.

---

## 5. Завершение и выдача награды

1. После одобрения поста пользователь нажимает “Завершить квест” (или это делает система автоматически).
2. `POST /runs/{run_id}/complete`:
   - проверяются все условия,
   - статус `completed`,
   - создаётся запись в `QuestRewardLog`,
   - инициируется выдача NFT (и опционально Points).
3. Пользователь видит NFT-бейдж в своём профиле.

---

## 6. Использование премиум-ваучеров внутри квеста (обзор)

1. Шаг квеста типа `premium_voucher` содержит `required_premium_voucher_id`.
2. Во время прохождения:
   - UI направляет пользователя в интерфейс покупки премиум-ваучера (Voucher Service).
3. После успешной покупки:
   - Voucher/Points/Token сервисы:
     - начисляют награды партнёру и PRO;
   - Quest Service может:
     - пометить соответствующий чекпоинт как выполненный (на позднем этапе через интеграцию/вебхуки).
