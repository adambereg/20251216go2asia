# User Service — Security

## Аутентификация

- JWT access-токен:
  - срок жизни: 15–60 минут.
  - подписывается секретом или private key (RS256/ES256).
- Refresh-токен:
  - срок жизни: 7–30 дней.
  - хранится как opaque-строка с hash в БД (или как JWT + blacklist).
- Все защищённые эндпоинты других сервисов:
  - принимают access-token в `Authorization: Bearer ...`;
  - проверяют подпись и срок действия;
  - доверяют claim `sub` (user_id) и `role` (primary_role).

## Авторизация

Роли:

- `anonymous` (без токена) — минимальный доступ (регистрация, логин).
- `user` — базовый доступ к функционалу платформы.
- `vip` — дополнительные возможности (больше лимиты, доступ к VIP-контенту/фичам).
- `pro` — доступ к PRO-инструментам:
  - создание квестов,
  - участие в RF-программе как куратор,
  - отображение в Guru (при `visible_in_guru = true`).
- `business_partner_owner` — доступ к партнёрскому кабинету RF.
- `moderator`, `admin` — модерация и администрирование.

Проверка прав:

- на уровне middleware/guards (roles-based);
- на уровне бизнес-логики (например, PRO не может менять себе роль на admin).

## Хранение паролей

- Только хэши (bcrypt/Argon2).
- Выбор адекватного cost (чтобы хэширование было достаточно тяжёлым).
- Никаких логов сырых паролей.

## PII и логи

- В логах не писать:
  - пароли,
  - токены,
  - email целиком (по возможности),
  - номера телефонов.
- Для корреляции запросов:
  - `correlation_id`, `user_id` (но не email/телефон).

## Транспортная безопасность

- Все внешние запросы — HTTPS.
- Внутри кластера — HTTPS/mTLS.

## Защита от brute force

- Rate limiting по IP на:
  - `/auth/login`,
  - `/auth/register`,
  - `/auth/request-password-reset`.
- Временная блокировка учётной записи при большом количестве неудачных попыток (опционально).

## Управление контактами PRO

- Публичные контакты (`contacts_public`) показываются только:
  - если пользователь PRO,
  - и явно включил видимость (флажок в настройках).
- Пользователь уведомляется, что его контакты будут видны другим пользователям.

## Удаление и блокировка учётной записи

- Soft-delete:
  - пометка `status = deleted`, а не физическое удаление (чтобы не ломать связи).
- Возможность экспорта/запроса на удаление в будущем (для полной соответствия GDPR/аналогам).
