# NFT Service — Security

NFT Service управляет «репутационными активами» пользователей, а также связан с ончейн-токенами, поэтому к нему предъявляются повышенные требования по безопасности.

---

## 1. Модель доступа

NFT Service — **внутренний** сервис.

Доступ имеют только:

- **Connect Service** — для выдачи/апгрейда NFT по RewardAction;
- **Blockchain Gateway Service** — для callback’ов по ончейн-минту;
- **Admin/BFF сервисы** — для чтения и управления типами и уровнями (под строгой авторизацией).

Прямой доступ от фронтенда к NFT Service запрещён:
- фронтенд работает через API Gateway/BFF, который:
  - преобразует пользовательские запросы,
  - проверяет права,
  - делает s2s-запросы.

---

## 2. Аутентификация и авторизация

- Все запросы к `/internal/*`:
  - проходят **service-to-service** аутентификацию (JWT сервисов, mTLS, private network).
- Для каждого клиентского сервиса в конфигурации указано:
  - какие маршруты он может вызывать:
    - `connect_service`:
      - `/internal/reward`,
      - `/internal/mint_simple` (опционально);
    - `blockchain_gateway_service`:
      - `/internal/onchain/callback`;
    - `admin_panel`/`bff`:
      - `/internal/user/{id}`,
      - `/internal/search`,
      - `/internal/types*`,
      - `/internal/levels*`.

---

## 3. Аудит и логирование

- Ведение **NFTAuditLog** для ключевых действий:
  - создание NFTInstance,
  - изменение уровня,
  - изменение статуса (revoked, burned_onchain),
  - переходы ончейн-статусов,
  - изменения NFTType и NFTLevelRule.
- Логи API:
  - кто (какой сервис) вызывал какой endpoint,
  - с какими параметрами,
  - с каким результатом.

---

## 4. Защита от злоупотреблений

Хотя NFT не являются прямыми денежными активами, их можно монетизировать вне платформы (особенно on‑chain).  
Меры:

- чёткое разделение ролей:
  - Connect решает, кому выдавать — NFT Service не принимает произвольные пользовательские запросы на mint;
- контроль админских операций:
  - отдельные роли/permissions для изменения правил и типов;
- ограничение прямого минта по `submit_onchain` только:
  - либо из внутренних процессов,
  - либо через проверенный BFF с бизнес-правилами (например, «оплатить токенами вывод в ончейн»).

---

## 5. Надёжность

- При внутренних сбоях (ошибка БД, сети) операции:
  - либо не применяются вовсе,
  - либо внятно помечаются статусами `failed` в очередях и onchain_status.
- Идемпотентность по `external_id` позволяет безопасно повторять запросы от Connect и не создавать дубли NFT.
