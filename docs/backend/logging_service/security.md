# Logging & Analytics Service — Security

Logging & Analytics Service оперирует потенциально чувствительной информацией о внутренней работе системы. Ошибки в безопасности могут привести к:

- утечке данных,
- раскрытию PII через логи,
- компрометации внутренних структур.

Поэтому безопасность — ключевой аспект.

---

## 1. Сетевой доступ и аутентификация

### Ingestion API (логирование, трассы, аналитика)

- только из приватной сети / кластерной overlay-сети;
- все запросы идут по **mTLS** (взаимная аутентификация по сертификатам);
- поверх TLS — **service JWT**, где:
  - `iss` — «go2asia-backend»,
  - `sub` — имя сервиса (`atlas_service`, `voucher_service`, `blockchain_gateway_service` и т.п.),
  - `aud` — `logging_analytics_service`.

Запросы без валидного сертификата или токена — отклоняются.

### Admin / Read API

- только из административной подсети/VPN;
- требуются:
  - admin-токен (JWT с ролями),
  - или интеграция с SSO (в будущем).

---

## 2. Контроль PII в логах

Правило: **логи не являются хранилищем персональных данных**.

### Политика:

- запрещено логировать:
  - email, телефон, паспорт, TON-адрес, ФИО;
  - сырые запросы с такими данными;
- разрешены:
  - `user_id` (внутренний UUID),
  - `anonymous_user_id` (для аналитики).

### Технические меры:

- Log Collector запускает pipeline с scrubber-фильтрами:
  - ищет поля по известным ключам (`email`, `phone`, `passport`, `ton_address` и т.д.);
  - применяет регулярки к значениям;
  - замещает их масками (`***` или `hash`).

---

## 3. Разграничение доступа (RBAC)

Не все члены команды должны видеть всё.

Пример ролей:

- **DEV**:
  - доступ к логам «своих» сервисов (atlas, guru, rielt и т.п.);
  - доступ к техническим метрикам.
- **LEAD / ARCHITECT**:
  - доступ ко всем логам, трассам, метрикам.
- **SECURITY**:
  - доступ к security-логам,
  - дашбордам по аномальным действиям.
- **PRODUCT / ANALYST**:
  - доступ только к агрегированной аналитике,
  - без сырых логов.

---

## 4. Защита от log injection / log forging

- экранирование CR/LF, чтобы никто не мог «разорвать» лог и внедрить поддельные записи;
- строгое форматирование JSON;
- контроль длины строк в `message` и `error_stack`.

---

## 5. Хранение и ретеншн

- Сырые логи:
  - хранятся ограниченное время (например, 7–30 дней),
  - затем агрегируются/архивируются.
- Security-логи:
  - могут храниться дольше (например, 90–180 дней),
  - в отдельном индексе с ограниченным доступом.
- Analytics events:
  - хранятся дольше (месяцы/годы), но обезличены.

---

## 6. Инцидент-менеджмент

Если обнаружена утечка PII в логах:

1. Немедленно закрыть доступ к соответствующему индексу.
2. Включить дополнительное scrubber-правило.
3. Пересмотреть код сервисов-источников.
4. Задокументировать инцидент.
