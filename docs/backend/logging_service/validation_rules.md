# Logging & Analytics Service — Validation Rules

Валидация критична, чтобы:

- не захламлять хранилища мусором,
- не допустить утечки PII,
- сохранить пригодность логов и аналитики для поиска и агрегаций.

---

## 1. Общие требования

Для всех типов данных (логи, спаны, метрики, события аналитики):

- обязательное поле `timestamp`/`occurred_at`;
- обязательное поле `service` или `service_name` (где применимо);
- максимальный размер полезной нагрузки (например, тело JSON ≤ 32KB);
- никакого произвольного бинарного/закодированного в base64 тела в `message`.

---

## 2. Validation — LogEntry

### Обязательные поля

- `service` — непустая строка из списка зарегистрированных сервисов;
- `level` — одно из: `debug`, `info`, `warn`, `error`, `security`;
- `timestamp` — валидный ISO-формат;
- `message` — непустая строка.

### Формат `correlation_id`

- UUID / ULID / другой согласованный формат;
- если приходит пустой, фронтовой/BFF middleware должен генерировать новый, чтобы цепочка была полной.

### Ограничение на `context`

- размер сериализованного JSON ≤ 10 KB;
- запрещено отправлять туда:
  - исходные запросы целиком (например, тело multipart upload),
  - большие binary blobs.

### PII Protection

- email, телефон, паспортные данные, TON-адрес, ФИО **не должны** попадать в лог;
- если сервис всё же отправил такие поля:
  - Log Collector должен иметь scrubber, который вырезает/маскирует их.

---

## 3. Validation — TraceSpan

- `trace_id` — обязателен;
- `span_id` — обязателен;
- `service_name` — обязателен;
- `operation_name` — длина ≤ 256 символов;
- `duration_ms` ≥ 0 и ≤ разумного максимума (например, 7 дней, чтобы отсечь мусор);
- кол-во вложенных spans в одной трассе ограничено (например, ≤ 1000).

Теги (`tags`):

- не должны содержать PII;
- стандартные ключи:
  - `http.method`, `http.path`, `http.status_code`,
  - `db.system`, `db.statement` (обрезанный),
  - `error`, `error.message`.

---

## 4. Validation — Metrics

- `metric_name` должен соответствовать принятому неймингу:
  - `service_action_unit`, например:
    - `guru_geo_search_latency_ms`,
    - `voucher_purchase_count`.
- значения:
  - для gauge/histogram — float ≥ 0;
  - для counter — только монотонно возрастают.
- `labels`:
  - ограниченная кардинальность (нельзя ставить `user_id`, `request_id`);
  - допустимы:
    - `service`,
    - `endpoint`,
    - `city`,
    - `status_code`,
    - `env`.

---

## 5. Validation — AnalyticsEvent

- `event_name` — whitelisted (предопределённый список);
- `anonymous_user_id` — непустая строка, но **не user_id**;
- `payload`:
  - не содержит PII,
  - поля и типы должны быть документированы (schema),
  - размер ≤ 8KB.

Если событие нарушает правила, оно либо:

- отбрасывается (для аналитики это допустимо),
- либо логируется отдельно как `analytics_validation_error` для исправления.
