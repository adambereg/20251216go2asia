# Points Service — Validation Rules

Основная задача валидации — избежать:

- некорректных транзакций,
- отрицательных балансов (кроме явно разрешённых случаев),
- несогласованности данных.

## 1. Общие проверки

Для всех операций:

- `user_id` — обязателен и должен быть валидным UUID;
- `amount > 0`;
- `currency`:
  - на этапе MVP: только `"points"`;
- `source_service` — обязателен;
- при наличии `external_id`:
  - строка фиксированной/ограниченной длины.

Если нарушается базовая валидация — возвращается `400 Bad Request`.

---

## 2. Идемпотентность (`external_id`)

- При наличии `external_id`:
  - Points Service ищет существующую транзакцию с этим `external_id`.
  - Если транзакция найдена с `status = completed`:
    - возвращает данные существующей транзакции,
    - не создаёт новую.
  - Если транзакция найдена с `status = failed`:
    - логика может:
      - либо запрещать повтор (возвращать ошибку),
      - либо разрешать повтор, если ошибка была технической.

Рекомендуется:
- всегда передавать `external_id` для Connect и критичных бизнес-операций.

---

## 3. Валидация credit

- `amount > 0`;
- `reason` не пустой;
- `source_service` не пустой.

Конфликт:

- если `external_id` уже использован для `credit` с отличающимися параметрами:
  - возвращать `409 Conflict`.

---

## 4. Валидация debit

- перед выполнением списания:
  - `available_balance(user_id) >= amount`;
- не допускается, чтобы `available_balance` стал < 0,
  - если только архитектурно не предусмотрено «кредитование».

Ошибки:

- `INSUFFICIENT_FUNDS` — если средств недостаточно;
- `USER_NOT_FOUND` — если пользователь не существует (опционально, в зависимости от стратегии).

---

## 5. Валидация hold

- `available_balance(user_id) >= amount`;
- при создании холда `status` всегда `active`;
- при повторных запросах с `external_id`:
  - поведение аналогично транзакциям.

---

## 6. Валидация release/capture

- холд с `hold_id` должен существовать;
- `status` холда должен быть `active`;
- при частичном `release`/`capture`:
  - сумма <= текущего `amount` холда.

---

## 7. Reconciliation и борьба с несоответствиями

При обнаружении несоответствия:

- раз в N часов/дней можно запускать фоновую задачу:
  - пересчитать баланс пользователя по журналу транзакций;
  - если расхождение:
    - логировать событие,
    - опционально автоматически корректировать `UserBalance`.
