# Points Service — Caching Strategy

Основная цель кеширования — ускорить:

- получение текущего баланса пользователя,
- отображение данных в личном кабинете и других интерфейсах, где баланс нужен часто.

## 1. Кеш баланса пользователя

### Подход

- Использовать:
  - агрегированную таблицу `UserBalance` в БД,
  - опционально — Redis или аналог для кеша.

### Ключи в Redis

- `points:balance:{user_id}`:
  ```json
  {
    "available_balance": 1200,
    "total_balance": 1500,
    "updated_at": "2025-01-10T10:00:00Z"
  }
  ```

### Обновление кеша

- При каждой успешной операции `credit`/`debit`/`hold`/`release`/`capture`:
  - пересчитывается баланс на уровне БД,
  - кеш перезаписывается свежими значениями.

### TTL

- Можно установить TTL (например, 5–10 минут) как защиту:
  - от «вечного» устаревания,
  - но даже без TTL обновление при транзакциях уже даёт хорошую консистентность.

---

## 2. Кеш истории транзакций

- История часто нужна меньше, чем баланс.
- Возможные варианты:
  - кешировать только последнюю страницу транзакций пользователя,
  - или не кешировать вовсе на MVP-этапе и полагаться на индексы БД.

---

## 3. Что не кешируется

- Полный журнал `PointsTransaction`:
  - является источником истины,
  - запрашивается в основном для админки и аналитики,
  - кеширование не даёт большого выигрыша, зато усложняет поддержание консистентности.

---

## 4. Reconciliation и кеш

- Периодические задачи пересчёта балансов:
  - могут временно игнорировать кеш и работать только с БД,
  - по завершению — обновлять `UserBalance` и при необходимости кеш.
