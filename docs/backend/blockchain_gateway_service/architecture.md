# Blockchain Gateway Service — Architecture

## Уровни и компоненты

### 1. API Layer

- REST API `/internal/blockchain/v1/*`.
- Обеспечивает:
  - аутентификацию сервисов (mTLS + JWT),
  - первичную валидацию входных запросов,
  - маппинг запросов на доменную модель (`BlockchainTask`).

### 2. Task Orchestrator

- Основной компонент бизнес‑логики.
- Создаёт и обновляет `BlockchainTask`.
- Переводит задачи по статусам:
  - `pending` → `signed` → `sent` → `confirmed`/`failed`.
- Управляет повторными попытками (retry) при временных ошибках сети.

### 3. Signing Engine

- Ответственен за:
  - подготовку транзакций под требования TON (структуры сообщений),
  - обращение к HSM/Vault для подписи,
  - формирование «сырого» payload в формате, ожидаемом нодой TON.

### 4. TON Sender

- Отправляет подписанные транзакции в сеть TON:
  - через TonAPI / Lite Client / tonlibjson (в зависимости от выбранного стека).
- Возвращает:
  - хэш транзакции,
  - первичную информацию по результату приёма.

### 5. TON Listener / Poller

- Подписывается на обновления состояния блокчейна:
  - через TonAPI/тон‑нод/tonlib.
- Для каждой `BlockchainTask` со статусом `sent`:
  - периодически проверяет состояние транзакции по `tx_hash`,
  - по достижении нужного количества подтверждений:
    - ставит `status = confirmed` или `failed`,
    - инициирует callback в инициирующий сервис.

### 6. Wallet Linking Engine

- Обрабатывает:
  - `wallet/link/request`,
  - `wallet/link/confirm`.
- Генерирует challenge‑строку.
- Проверяет подпись, используя возможности TON.

### 7. Storage Layer

- Работа с БД: `blockchain_tasks`, `wallet_bindings`, `gateway_audit_log`.

---

## Взаимодействие с другими сервисами

- **Connect Service**:
  - решает «кому и сколько G2A выдать/перевести»,
  - передаёт в Gateway конкретные команды.
- **Points Service**:
  - может инициировать `burn` G2A при обратной конверсии.
- **NFT Service**:
  - отвечает за NFT‑бейджи,
  - при решении вынести их on-chain вызывает `nft/mint` или `nft/upgrade`.
- **User Service / BFF**:
  - инициируют wallet linking.

---

## Масштабирование и отказоустойчивость

- API Layer и Task Orchestrator могут масштабироваться горизонтально.
- Для очередей можно использовать:
  - либо реляционную БД и периодический poller,
  - либо внешние брокеры (Kafka/RabbitMQ/SQS), в зависимости от инфраструктуры.
- Для TON Listener имеет смысл несколько воркеров с распределением задач.

---

## Консистентность

- Оффчейн учёт (Points, Connect, NFT Service) остаётся источником бизнес‑истины.
- On-chain — внешний отражённый слой.
- Gateway обеспечивает:
  - «как минимум один раз» семантику исполнения,
  - идемпотентность через `external_id` и аккуратную обработку callback’ов.
