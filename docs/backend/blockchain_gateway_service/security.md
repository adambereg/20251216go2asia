# Blockchain Gateway Service — Security

Blockchain Gateway — один из наиболее критичных и чувствительных сервисов Go2Asia.  
Его компрометация = прямой риск потери on-chain активов.

## 1. Изоляция и доступ

- Сервис развёрнут в приватной сети (VPC) / отдельном namespace.
- Доступ к HTTP‑интерфейсу:
  - только с адресов/namespace других backend‑сервисов,
  - только по mTLS (взаимная TLS‑аутентификация),
  - поверх этого — service JWT с проверкой `aud`, `iss`, `sub` (название сервиса).

Список доверенных сервисов:

- `connect_service`
- `points_service`
- `nft_service`
- `user_service`
- `admin_api` (ограниченно)

Любая попытка доступа «извне» → немедленный отказ + лог `security_violation`.

---

## 2. Управление ключами

- Приватные ключи minter’а G2A, NFT‑коллекций и кастодиальных кошельков:
  - генерируются и хранятся в HSM / Hardware Security Module или облачном Vault (Yandex Lockbox аналогов, если в будущем будет интеграция).
  - никогда не выгружаются в виде открытого ключа на диск.
- Подпись транзакций:
  - выполняется через защищённый API Vault, либо через локальный HSM‑агент.
- Регулярная ротация ключей (там, где это возможно, без нарушения ончейн‑контрактов):
  - документы и runbook по ротации должны быть отдельно описаны (операционный уровень, не в коде сервиса).

---

## 3. Политики лимитов и антифрода

- Ежесуточные и ежемесячные лимиты на вывод G2A:
  - per user,
  - per address,
  - per тип операции.
- Velocity‑проверки:
  - ограничение числа операций за час/день.
- Логирование аномалий:
  - всплеск активности,
  - необычно крупные суммы,
  - попытки вывода на «новые» адреса.
- (Фаза 2) Интеграция с **AML/KYT** провайдерами TON:
  - проверка адресов на участие в мошеннических схемах,
  - возможная блокировка операций для «грязных» адресов.

---

## 4. Аудит и трассировка

- Все ключевые действия пишутся в `GatewayAuditLog`.
- Логи передаются в централизованную систему логирования (ELK/ClickHouse/Cloud Logging).
- Уровни:
  - INFO — нормальные операции,
  - WARN — пограничные/подозрительные,
  - ERROR — ошибки,
  - SECURITY — подозрение на атаку или компрометацию.

Для on-chain операций можно включать корреляционные ID, чтобы связывать:

- событие в Connect/Points/NFT,
- запись в BlockchainTask,
- реальную транзакцию в TON.

---

## 5. Защита от неправильной конфигурации

- Конфигурация (адреса нод, ключи, лимиты) хранится в:
  - Env + Vault, без жёсткого захардкода в коде.
- Требуются проверки при старте:
  - подключение к TON ноде,
  - доступ к Vault/HSM,
  - валидация базовых лимитов (чтобы нельзя было случайно выставить «безлимит» для вывода).
