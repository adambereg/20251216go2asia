# Blockchain Gateway Service — Workflows

В этом документе перечислены основные сквозные сценарии с участием Blockchain Gateway.

---

## 1. Награда в виде G2A за квест

1. Пользователь выполняет квест.
2. Quest Service публикует событие.
3. Connect Service:
   - начисляет Points через Points Service,
   - решает выдать G2A (например, бонусом),
   - вызывает `POST /g2a/mint` в Gateway.
4. Gateway:
   - создаёт `BlockchainTask` со статусом `pending`,
   - через Signing Engine формирует и подписывает транзакцию,
   - отправляет её в TON (`status = sent`),
   - Listener ждёт подтверждения,
   - по подтверждению → `status = confirmed`.
5. Gateway:
   - логирует результат в GatewayAuditLog,
   - при необходимости вызывает callback в Connect.

---

## 2. Вывод G2A на внешний TON-кошелёк пользователя

### Этап 1: привязка кошелька

1. Пользователь в личном кабинете вводит TON‑адрес.
2. BFF/User Service вызывает `POST /wallet/link/request`.
3. Gateway возвращает `challenge`.
4. Пользователь подписывает challenge своим кошельком.
5. BFF/User Service отправляет `POST /wallet/link/confirm` с подписью.
6. Gateway:
   - проверяет подпись,
   - помечает запись в WalletBinding как `verified`.

### Этап 2: вывод

1. Пользователь инициирует вывод G2A.
2. Connect:
   - проверяет баланс G2A в своей оффчейн‑модели,
   - проверяет бизнес‑правила (кто может выводить),
   - вызывает `POST /g2a/transfer` в Gateway.
3. Gateway:
   - проверяет лимиты и velocity,
   - создаёт `BlockchainTask`,
   - подписывает и отправляет транзакцию в TON.
4. Listener:
   - отслеживает подтверждение,
   - обновляет статус задачи,
   - запускает callback в Connect (при необходимости).

---

## 3. Выпуск on-chain NFT-бейджа

1. NFT Service определяет, что бейдж пользователя должен быть вынесен в блокчейн:
   - достигнут редкий уровень,
   - пользователь запросил ончейн‑репрезентацию.
2. NFT Service вызывает `POST /nft/mint` в Gateway.
3. Gateway:
   - создаёт `BlockchainTask`,
   - формирует metadata в формате NFT коллекции TON,
   - подписывает транзакцию,
   - отправляет её в сеть.
4. После подтверждения транзакции:
   - Listener получает статус,
   - Gateway вызывает callback в NFT Service,
   - NFT Service обновляет `onchain_status` и `onchain_token_id` у NFTInstance.

---

## 4. Upgrade NFT (повышение уровня)

1. Пользователь достигает нового уровня по NFT.
2. NFT Service:
   - повышает уровень оффчейн,
   - решает обновить ончейн‑репрезентацию.
3. NFT Service вызывает `POST /nft/upgrade`.
4. Gateway:
   - создаёт задачу,
   - может выполнить две операции:
     - burn старого токена,
     - mint нового токена с обновлённым metadata.
   - отслеживает подтверждение.
5. Callback информирует NFT Service о новых `onchain_token_id` и статусе операции.

---

## 5. Failure & Retry

1. В процессе отправки транзакции TON‑провайдер вернул ошибку (например, временную).
2. Gateway:
   - увеличивает `retry_count`,
   - если лимит попыток не достигнут — планирует повтор.
3. Если ошибка перманентная (например, неверный адрес):
   - `status = failed`,
   - в `last_error` и GatewayAuditLog фиксируется причина.
4. Инициатор (Connect/NFT/Points) может по запросу статуса задачи принять решение:
   - попробовать снова (с новыми параметрами),
   - оповестить пользователя об ошибке.
