# Blockchain Gateway Service — Validation Rules

Валидация критична: ошибки могут привести к потере средств или блокировке токенов.

## 1. Общие правила

- Все запросы должны содержать:
  - `external_id` (строка, не пустая),
  - `user_id` (валидный UUID),
  - `source_service` (из списка разрешённых).
- Повторный запрос с тем же `external_id` и `source_service` должен быть идемпотентным:
  - возвращать существующую задачу,
  - не создавать дубликаты.

Если `external_id` уже использован для другой операции — `409 Conflict`.

---

## 2. G2A: mint/transfer/burn

### Проверки:

1. **amount**
   - `amount > 0`.
   - не превышает максимально допустимое значение для одного запроса.

2. **user_id**
   - существует в User Service (проверка через internal API или кеш).

3. **to_address / from_address**
   - соответствуют формату TON‑адреса (base64, длина).
   - при выводе на внешний кошелёк:
     - адрес должен принадлежать пользователю (WalletBinding.verified = true),
     - либо явное override только для админских операций.

4. **лимиты и velocity**
   - не превышены суточные/месячные лимиты по объёму вывода.
   - не превышено количество операций за период (например, не более N выводов в час).

5. **business constraints**
   - для `burn` — наличие соответствующей оффчейн‑операции (например, конвертации в Points) может проверяться через Connect/Points (опционально).

---

## 3. NFT: mint/upgrade

### Проверки для `/nft/mint`:

- `nft_id` существует в NFT Service (по internal запросу или через событие).
- `user_id` — владелец оффчейн NFTInstance.
- `metadata`:
  - содержит обязательные поля: `type_code`, `level`, `title`.
  - не превышает допустимый размер для TON metadata (если метаданные встраиваются напрямую).
  - ссылки `image_url` указывают на CDN/хранилище (URL с допустимыми доменами).
- `external_id` не дублирует прошлые транзакции.

### Проверки для `/nft/upgrade`:

- `current_onchain_token_id` указан и валиден для данного `nft_id`.
- новый `level` выше старого (если это бизнес‑правило).
- корректность бизнес‑процесса (не позволяет «понижение» уровня, если это не предусмотрено).

---

## 4. Wallet linking

### `/wallet/link/request`:

- `ton_address`:
  - валидный формат TON‑адреса.
  - не заблокирован (если есть blacklist).
- нет активного незавершённого challenge для этой пары `user_id + ton_address`.

### `/wallet/link/confirm`:

- challenge существует и не просрочен.
- `signature` корректно верифицируется публичным ключом кошелька (через TON libs).
- `ton_address` ещё не привязан к другому пользователю.
- при успехе выставляется `verified = true`.

---

## 5. Callback `/callback/tx`

- `task_id` должен существовать в BlockchainTask.
- изменение статуса допустимо:
  - из `sent` → `confirmed`/`failed`,
  - повторное `confirmed` игнорируется (идемпотентность).
- при `status = confirmed`:
  - `tx_hash` не пустой.
- при `status = failed`:
  - должен быть указан `error` или содержимое `raw.code / raw.message`.

В случае несоответствий — логируется `security_violation` в GatewayAuditLog.
