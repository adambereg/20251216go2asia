# Connect Service — Integrations

Connect Service занимает центральное место между доменными микросервисами
(которые генерируют события) и финансово-наградными микросервисами
(Points, NFT, Blockchain Gateway).

## Источники событий

### 1. Referral Service

- События:
  - `referral.joined` — новый реферал первого уровня.
  - `referral.subjoined` — субреферал второго уровня.
  - `referral.user_upgraded_to_vip` — реферал стал VIP.
  - `referral.user_upgraded_to_pro` — реферал стал PRO.
- Connect:
  - начисляет Points за регистрацию реферала (1-й уровень),
  - для субрефералов — либо сразу (если спонсор уже VIP/PRO),
    либо создаёт награду с `locked_until_condition = "vip_or_pro"`,
  - начисляет ongoing-награды с покупок реферала/субреферала (через связанные события платежей/квестов/ваучеров),
    если уже достигнут VIP/PRO.

### 2. Quest Service

- События:
  - `quest.completed` — пользователь завершил квест.
- Connect:
  - начисляет Points путешественнику,
  - начисляет Points PRO-автору квеста (профит от покупок квеста),
  - может выдавать NFT-бейджи (за 1-й, 5-й, 10-й и т.д. квесты),
  - передаёт информацию о включённых премиум-ваучерах в Voucher/Points-логику.

### 3. Voucher Service

- События:
  - `voucher.premium_purchased` — покупка премиум-ваучера.
  - `voucher.premium_redeemed` — отоваривание премиум-ваучера.
- Connect:
  - начисляет Points бизнес-партнёру и PRO-спейсеру, который продвигал партнёра,
  - учитывает, что путешественник платит премиум-ваучер токенами + NFT:
    - NFT-часть может учитываться для выдачи отдельных бейджей или статусов,
  - может запускать дополнительные бонусы за высокую активность покупки ваучеров.

### 4. Rielt Service

- События:
  - `rielt.booking_paid` — успешная оплата бронирования жилья.
- Connect:
  - начисляет Points:
    - арендатору (как путешественнику),
    - владельцу жилья (если он привязан как партнёр),
    - реферальным спонсорам (если покупка была совершена рефералом/субрефералом).

### 5. RF Service (Russian Friendly)

- События:
  - `rf_partner.review_created` — создан отзыв о партнёре (через Reactions Service).
  - `rf_partner.review_high_rating` — отзыв с высокой оценкой (например, >=4).
- Connect:
  - начисляет Points за короткие отзывы и рейтинги (через `reaction.short_review` и `rating`),
  - может выдавать партнёрам и PRO-кураторам специальные награды за качественные отзывы.

### 6. Reactions Service

- События:
  - `reaction.created` (repost, short_review, completed, bookmark, и др.).
- Connect:
  - за `repost` может начислять Points за продвижение контента/мест/событий,
  - за `short_review` / `rating` — за создание социального капитала (отзывы о местах, жилье),
  - за `completed` — за прохождение квестов (если не полностью покрывается Quest Service),
  - учитывает тип `target` (место, событие, квест, RF-партнёр, объявление).

### 7. Другие сервисы (Atlas, Pulse, Blog, Guru, Space и т.д.)

- События:
  - публикации, достижения, активность в определённых разделах.
- Connect:
  - может использоваться для геймификации (например, Points за первый пост, за 10-й день активности подряд).

---

## Взаимодействие с Points Service

Points Service:

- принимает команды:
  - через Event Bus или REST (например, `/internal/points/credit`),
- ведёт строгий учёт балансов.

Connect Service:

- генерирует `RewardAction` с `reward_type = "points"`,
- публикует событие `connect.reward.points` или вызывает внутренний endpoint,
- ожидает подтверждения/обновления статуса (через callback-событие или синхронный ответ).

---

## Взаимодействие с NFT Service

NFT Service:

- управляет каталогом бейджей и владением NFT-бейджами.

Connect Service:

- при необходимости формирует `RewardAction` с `reward_type = "nft"`,
- передаёт:
  - `badge_type`,
  - пользователя,
  - метаданные (например, за какой квест/город/место получен бейдж),
- получает подтверждение или событие `nft.reward.completed`.

---

## Взаимодействие с Blockchain Gateway Service

Blockchain Gateway:

- работает с реальными on-chain токенами и NFT в TON (или другой сети),
- не содержит бизнес-правил, только инфраструктуру.

Connect Service:

- в особых случаях (например, конвертация накопленных внутренних токенов в on-chain G2A)
  формирует `RewardAction` с `reward_type = "g2a_onchain"`,
- вызывает Gateway:
  - `mint` / `transfer` / др. операции,
- использует события/ответы для обновления статуса `RewardAction`.

---

## Взаимодействие с Notification Service

Хотя Connect непосредственных уведомлений пользователям не рассылает, он:

- может публиковать события:
  - `points.awarded`,
  - `badge.earned`,
  - `tier.upgraded`,
- Notification Service подписывается на них и рассылает:
  - push/email/in_app-уведомления о наградах.

Таким образом, пользователь всегда знает, за что и сколько Points/NFT он получил.
