# Connect Service — Security

## 1. Аутентификация

Connect Service — полностью внутренний сервис.
Все его API должны быть доступны только:

- другим микросервисам Go2Asia,
- админ-инструментам (через API Gateway с аутентификацией).

Подходы:

- service-to-service JWT:
  - каждый сервис имеет свой сервисный ключ/токен,
  - `/internal/*` маршруты принимают только такие токены.
- или mTLS / внутренняя сеть с ограничениями.

Пользовательские JWT **не** используются напрямую в Connect Service.

---

## 2. Авторизация

- `/internal/events`, `/internal/events/batch`:
  - только микросервисы-источники (Referral, Quest, Voucher, Rielt, RF, Reactions и др.).
- `/internal/rules*`:
  - только админ-панель/конфигурационные сервисы с ролью `admin`/`economy_admin`.
- `/internal/reward-actions`, `/internal/events` (чтение):
  - только службы аналитики, админы, ops.

Никакой прямой возможности для внешнего клиента (пользователя) вызвать эти API быть не должно.

---

## 3. Целостность и защита от злоупотреблений

Connect Service принимает решения о наградах, поэтому:

- все изменения `RewardRule` должны логироваться с указанием:
  - кто, когда и что изменил,
  - старое и новое значения.
- желательно ограничить число людей и процессов, имеющих доступ к изменению правил,
- при критических изменениях (например, изменение размера вознаграждения за реферальный уровень)
  можно предусмотреть систему 4 глаз (approve).

---

## 4. Логирование и аудит

- Логируются:
  - все входящие события (`EconomicEvent`),
  - все созданные `RewardAction`,
  - все ошибки в rule engine и интеграциях с Points/NFT/Gateway,
  - изменения правил (`RewardRule`) и кампаний.
- Audit:
  - по `target_user_id` всегда можно восстановить,
    за что и когда пользователь получил награды.

---

## 5. Защита от инъекций и ошибок конфигурации

- `context` и `rewards` — JSON-поля:
  - должны валидироваться и использоваться аккуратно,
  - нельзя слепо подставлять значения из `context` в SQL/шаблоны без очистки.
- Неверные или конфликтующие правила:
  - внутренний tooling должен помогать находить дубли, конфликтующие правила,
  - может использоваться dry-run для проверки изменений правил на тестовых данных.
