# Notification Service — Security

## Аутентификация

- Внутренние API (`/internal/*`):
  - доступны только другим микросервисам,
  - защищены:
    - сервисными JWT-токенами,
    - либо API-ключами и сетевыми ограничениями (VPC, IP allowlist).
- Пользовательские API (`/user/*`):
  - требуют JWT пользователя:
    - `Authorization: Bearer <token>`.

---

## Авторизация

- `/internal/enqueue`, `/internal/enqueue_batch`:
  - доступны только доверенным сервисам (User, Reactions, Quest, Connect, RF, Rielt и др.).
- `/user/notifications`, `/user/notifications/{id}/open`:
  - пользователь может видеть и помечать только свои уведомления (по `user_id` из JWT).
- `/user/preferences` (Фаза 2):
  - только владелец учётной записи может читать/изменять свои предпочтения.
- `/admin/...` (если будут реализованы):
  - только роли `admin` / `support` / `moderator`.

---

## Конфиденциальность

- Notification Service хранит:
  - только минимум персональных данных:
    - `user_id`,
    - косвенно — email/телеграм-идентификаторы через внешние провайдеры или User Service.
- Тексты уведомлений (особенно с данными бронирований, ссылками) не должны содержать избыточно чувствительную информацию.

---

## Безопасность каналов

- Email:
  - отправка через TLS,
  - желательно минимизировать количество персональных данных в письме (использовать secure deeplinks).
- Push:
  - только через защищённые соединения с провайдерами.
- Telegram:
  - работа через официальное Bot API по HTTPS.

---

## Rate limiting и защита от злоупотреблений

- Ограничения на количество уведомлений:
  - на пользователя (per user),
  - по типу уведомления,
  - на источник (по сервису, IP или ключу).
- Защита от:
  - ошибочного массового спама из-за бага в доменном сервисе,
  - повторяющихся уведомлений.

---

## Логирование и аудит

- Логируются:
  - создание уведомлений,
  - смена статусов (`queued`, `sent`, `delivered`, `opened`, `failed`),
  - ошибки поставщиков.
- Аудит:
  - операции администраторов по пересылке/отмене рассылок,
  - изменения глобальных настроек провайдеров.
