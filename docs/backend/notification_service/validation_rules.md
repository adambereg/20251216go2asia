# Notification Service — Validation Rules

## Общие проверки

Для `POST /internal/enqueue` и `POST /internal/enqueue_batch`:

- `user_id`:
  - обязателен,
  - должен быть валидным UUID (формально можно не валидировать против User Service, но желательно).
- `channel`:
  - `email` | `push` | `telegram` | `in_app`;
  - может быть опциональным, если логика выбора канала будет определяться из предпочтений.
- `type`:
  - строковый код типа уведомления,
  - должен соответствовать зарегистрированным типам (конфигурация/список).
- `template_key`:
  - обязателен для каналов `email` и `push`,
  - для `in_app` может использоваться упрощённый формат.
- `payload`:
  - должен содержать все необходимые параметры для шаблона (на уровне бизнес-логики).

---

## Ограничения по размеру

- `payload`:
  - ограничение по максимальному размеру (например, 8–16 KB),
  - недопустима передача больших blobs/медиа.
- Диапазоны строк:
  - для полей вроде `user_name`, `title`, `preview_text` — разумные лимиты.

---

## Статусы

- При создании уведомления:
  - `status = "queued"`.
- В процессе отправки:
  - `status` может переходить в `sending`, `sent`.
- При успешной доставке:
  - обновление статуса на `delivered`.
- При открытии (по webhook’у или `POST /user/notifications/{id}/open`):
  - обновление статуса на `opened`.
- При ошибке провайдера:
  - `status = "failed"`,
  - `error_code` с текстом/кодом ошибки.

---

## Предпочтения пользователя (Фаза 2)

- При чтении `NotificationPreference`:
  - если записи нет — используется конфигурация по умолчанию.
- При обновлении (`PATCH /user/preferences`):
  - валидация ключей `channels_enabled` и `types_enabled`:
    - неизвестные типы и каналы могут игнорироваться или вызывать ошибку.
- Quiet hours:
  - формат `HH:MM`,
  - `start` и `end` должны быть валидным временем.

---

## Idempotency

- Для массовых рассылок:
  - возможна идентификация кампании/батча через доп. поля (`campaign_id`),
  - Notification Service может предотвращать повторную отправку по одному и тому же `campaign_id` и `user_id`
    (если это требуется бизнес-логикой).

---

## Anti-spam / Anti-abuse

- Ограничения по частоте:
  - на одного пользователя в единицу времени (например, не более X уведомлений в час),
  - на тип уведомлений (например, маркетинговые не чаще Y раз в неделю).
- Особые правила:
  - системные уведомления (`user.password_reset`, `thread.new_message`) не должны попадать под жёсткий спам-фильтр,
  - маркетинговые и дайджесты — наоборот, должны строго ограничиваться.
