# Referral Service — Обзор

## Назначение

**Referral Service** — микросервис реферальной программы экосистемы Go2Asia.

Он отвечает за:

- хранение *реферальных отношений* между пользователями (двухуровневая структура: рефералы и субрефералы);
- генерацию и трекинг реферальных ссылок / кодов;
- учёт реферальных событий (регистрация, покупки квестов, ваучеров, бронирований и т.п.);
- расчёт и фиксацию реферальных вознаграждений (в Points / G2A) на уровне событий, без непосредственного управления балансами;
- управление состоянием наград, которые могут быть заблокированы до апгрейда роли пользователя (VIP/PRO).

Referral Service — это “мозг” реферальной механики:

- каждый зарегистрированный пользователь (Spacer, VIP, PRO) получает реферальную ссылку;
- пользователи, зарегистрировавшиеся по ссылке, становятся его **рефералами (1-й уровень)**;
- рефералы могут приглашать свои рефералов — для исходного пользователя это **субрефералы (2-й уровень)**.

## Правила реферальной программы Go2Asia

1. **Два уровня:**
   - 1-й уровень — прямые рефералы;
   - 2-й уровень — субрефералы (рефералы твоих рефералов).

2. **Начисления за регистрацию:**
   - за каждого реферала пользователю начисляются Points и сразу отображаются в его балансе;
   - за каждого субреферала также начисляются Points, но они находятся в заблокированном состоянии и становятся доступны только после апгрейда пользователя до VIP или PRO.

3. **Начисления за покупки:**
   - после активации VIP/PRO пользователь начинает получать Points с покупок своих рефералов и субрефералов (квесты, ваучеры, бронирования и т.д.);
   - до апгрейда начисления за покупки не происходят (или считаются нулевыми — задаётся правилами кампании).

4. **Роли VIP/PRO:**
   - в реферальной схеме VIP и PRO не образуют отдельные структуры — это те же пользователи, но с ролью, которая:
     - разблокирует награды за субрефералов (за регистрации);
     - включает начисления за покупки рефералов и субрефералов.

PRO никак не “надстраиваются” над реферальным деревом — они просто участники с расширенными правами в других модулях (создание квестов, онбординг партнёров и т.п.), но в рефералке работают по тем же базовым правилам 1-го и 2-го уровней.

---

## Основные сценарии

1. **Приглашение новых пользователей**
   - Каждый пользователь получает реферальную ссылку.
   - Новый пользователь регистрируется по ссылке → становится рефералом пригласившего.
   - Рефералы приглашают далее — для исходного пользователя их рефералы становятся субрефералами.

2. **Реферальные события на покупки**
   - Покупка квестов, ваучеров, бронирований, платных сервисов и т.п.
   - Referral Service определяет реферальные уровни (кто 1-й, кто 2-й уровень) и рассчитывает вознаграждения по активной кампании.

3. **Рефералка для онбординга бизнес-партнёров RF**
   - PRO (или другой пользователь) может пригласить бизнес-партнёра.
   - После успешного онбординга партнёра формируется событие и вознаграждение.

Referral Service должен быть универсальным, чтобы описывать разные кампании и правила, но на уровне MVP реализуется упрощённая, но уже двухуровневая логика (реферал/субреферал + блокировка части наград до апгрейда роли).
