# Reactions Service — Caching Strategy

## Цели

- Ускорить доступ к агрегированной статистике по объектам
  (лайки, репосты, оценки, отзывы, отметки и т.д.).
- Минимизировать нагрузку на БД при массовом показе списков
  (каталоги мест, событий, квестов, RF-партнёров, ленты постов).

---

## Что кешируем

1. **Агрегаты по объектам (ReactionAggregate)**

- Ключ: `react:agg:{target_type}:{target_id}`
- Содержимое:
  - likes_count,
  - reposts_count,
  - bookmarks_count,
  - short_reviews_count,
  - feedback_count,
  - rating_sum / rating_count,
  - was_here_count / want_to_visit_count,
  - going_count / interested_count,
  - completed_count,
  - др. агрегаты по мере необходимости.

Обновление:

- при каждой новой/удалённой реакции соответствующего типа:
  - либо синхронно (для MVP),
  - либо асинхронно через воркер и Event Bus.

2. **Горячие ветки общения (threads)**

- Для популярных сценариев (много коротких сообщений):
  - можно кешировать последние N сообщений ветки:
    - ключ: `react:thread:{thread_id}:last_messages`.

---

## Что не кешируем

- сырые реакции `Reaction` (хранятся только в БД);
- подробные списки старых сообщений веток (запрашиваются редко).

---

## Технология

- Redis как основной кеш-слой.
- Важные моменты:
  - инвалидация кеша при обновлении/удалении реакций;
  - TTL для агрегатов (например, 30–120 секунд) как компромисс между точностью и производительностью.

---

## Батч-доступ

- Вместо множества отдельных запросов по одному объекту:
  - фронтенд/сервисы должны использовать `POST /stats/batch`.
- Реализация:
  - сначала попытка прочитать из Redis все аггрегаты,
  - затем дозапрос отсутствующих из БД с последующей записью в кеш.
