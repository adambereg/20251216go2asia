# ADR 0010: Синхронная коммуникация в MVP вместо event-driven

## Статус
Принято

## Дата решения
2025-01-16

## Контекст

В MVP Go2Asia требуется простая архитектура без сложных зависимостей. Полная экосистема Go2Asia использует event-driven архитектуру для начисления Points, уведомлений и аналитики, но для MVP это избыточно.

## Решение

Использовать только синхронные HTTP REST API для межсервисной коммуникации в MVP. Event-driven архитектура (очереди, брокеры сообщений) отложена на post-MVP.

## Обоснование

1. **Упрощение архитектуры:** Меньше компонентов для управления и отладки
2. **Меньше точек отказа:** Нет брокера сообщений, который может упасть
3. **Проще отладка:** Синхронные вызовы легче трассировать и логировать
4. **Достаточно для MVP:** Масштаб MVP не требует асинхронной обработки

## Последствия

### Плюсы
- Простота реализации и поддержки
- Предсказуемость поведения системы
- Легче отладка (синхронные вызовы видны в логах)
- Меньше инфраструктурных компонентов

### Минусы
- Связанность сервисов (один сервис может заблокировать другой)
- Потенциальные каскадные сбои
- Медленнее для длительных операций (нет фоновой обработки)

### Митигация рисков синхронной коммуникации

#### Таймауты для межсервисных вызовов

- **Стандартный таймаут:** 2 секунды для всех межсервисных вызовов
- **Критические вызовы:** 3 секунды (например, проверка JWT в Gateway)
- **Реализация:** Через `AbortController` и `signal` в Fetch API

#### Retry логика

- **Retry 0:** Для не-критических операций (начисление Points, генерация referral_code)
- **Retry 1:** Для критических операций (проверка JWT в Gateway)
- **Максимальная задержка:** 500ms между попытками
- **Retry только для:** Временных ошибок (5xx, network errors)

#### Graceful Degradation (Постепенная деградация)

**Сценарий 1: Points Service недоступен при регистрации пользователя**
- Действие: Регистрация пользователя продолжается без начисления Points
- Логирование: Ошибка логируется с requestId
- Восстановление: Points могут быть начислены позже через фоновую задачу (post-MVP)

**Сценарий 2: Auth Service недоступен при проверке JWT**
- Действие: Gateway возвращает 503 Service Unavailable
- Логирование: Критическая ошибка логируется
- Восстановление: Требуется немедленное вмешательство (Auth Service критичен)

**Сценарий 3: Referral Service недоступен при регистрации**
- Действие: Регистрация продолжается без генерации referral_code
- Логирование: Ошибка логируется с requestId
- Восстановление: referral_code может быть сгенерирован позже при первом запросе пользователя

**Сценарий 4: Points Service недоступен при регистрации на событие**
- Действие: Регистрация на событие сохраняется, но Points не начисляются
- Логирование: Ошибка логируется с requestId
- Восстановление: Points могут быть начислены позже через фоновую задачу

#### Мониторинг и алерты

- Алерты на высокий процент ошибок (error rate > 5%)
- Алерты на высокую латентность (p95 latency > 500ms)
- Алерты на таймауты межсервисных вызовов

#### Circuit Breaker (в будущем)

- В MVP не реализован (избыточно)
- В post-MVP может быть добавлен для автоматического отключения недоступных сервисов

## Альтернативы

### Альтернатива 1: Event-driven архитектура
- Использовать брокер сообщений (RabbitMQ, Kafka, Cloudflare Queues)
- Плюсы: Развязка сервисов, масштабируемость
- Минусы: Сложность для MVP, дополнительные компоненты, сложнее отладка
- Решение: Отложено на post-MVP

### Альтернатива 2: gRPC
- Использовать gRPC для межсервисной коммуникации
- Плюсы: Высокая производительность, типизация
- Минусы: Избыточно для MVP, сложнее настройка
- Решение: Отложено на post-MVP

## Связанные решения

- ADR 0007: Правила выделения границ микросервисов
- ADR 0006: API Gateway стратегия

## Примечания

В post-MVP планируется переход на event-driven архитектуру для:
- Начисления Points (асинхронная обработка)
- Отправки уведомлений (фоновые задачи)
- Аналитики (обработка событий)

