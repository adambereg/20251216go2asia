# Руководство по деплою фронтенда Go2Asia (PWA)

Этот документ описывает, как разворачивать фронтенд Go2Asia (PWA shell + модули) на Netlify с использованием Cloudflare.

---

## 1. Предварительные требования

- Репозиторий Go2Asia в GitHub (монорепо).
- Настроенный Netlify-проект, привязанный к репозиторию.
- Настроенный Cloudflare-домен `go2asia.app` (см. `../cloudflare_setup.md`).
- Установлены:
  - Node.js (актуальная LTS),
  - pnpm (в проекте).

---

## 2. Основной сценарий деплоя на production

### Шаг 1. Подготовка кода

1. Убедиться, что нужные изменения слиты в ветку `main`.
2. Проверить локально:
   - `pnpm install`
   - `pnpm lint`
   - `pnpm typecheck`
   - `pnpm build`

Если всё успешно — готово к деплою.

---

### Шаг 2. Проверка переменных окружения в Netlify

В Netlify → **Site settings → Build & deploy → Environment**:

Обязательно задать:

- `NODE_ENV=production`
- `NEXT_PUBLIC_API_BASE_URL` (или аналогичный базовый URL API Gateway)
- другие переменные, необходимые фронтенду (аналитика, Sentry и т.п.)

Следить, чтобы в этих переменных **не было секретов**, которые нельзя светить в браузере.

---

### Шаг 3. Автодеплой из ветки main

По умолчанию Netlify настроен так, что:

- любой push в `main` → триггерит сборку и деплой.

Сборка:

- **Build command:**
  - `pnpm install --frozen-lockfile && pnpm build`
- **Publish directory:**
  - в соответствии с используемым фреймворком (Next.js/SPA) — зафиксировано в README фронтенда.

Если билд упал — необходимо:

1. Открыть вкладку **Deploys** в Netlify.
2. Посмотреть логи.
3. Исправить ошибки в коде/конфигурации и снова запушить в `main`.

---

### Шаг 4. Проверка деплоя

1. Убедиться, что новый билд в Netlify помечен как **Published**.
2. Открыть production-домен:
   - `https://go2asia.app`
3. Проверить:
   - загрузку главной страницы,
   - работу нескольких ключевых маршрутов (Atlas, Pulse, Blog),
   - работу запросов к API (через DevTools → Network).

---

## 3. Деплой на staging

Staging обычно привязан к ветке `develop`.

### Шаги:

1. В Netlify настроить **Branch deploy** для `develop`:
   - отдельный URL, например: `https://staging-go2asia.netlify.app` или поддомен `staging.go2asia.app`.
2. Задать отдельный набор переменных окружения для staging:
   - `NEXT_PUBLIC_API_BASE_URL` должен вести на staging API.
3. Любой push в `develop` → автоматический деплой на staging.

Использование:

- проверка фич перед релизом в prod;
- интеграционные/ручные тесты.

---

## 4. Preview-деплои (для Pull Requests)

Netlify умеет создавать **Deploy Previews**:

- при открытии PR в GitHub:
  - автоматически создаётся отдельный билд и URL с этим билдом;
- ссылка на превью добавляется в Pull Request.

Использование:

- удобная проверка UI/UX,
- ревью фич до мержа в `develop`/`main`.

---

## 5. Роллбэк фронтенда

Если после деплоя обнаружены критические проблемы:

1. Открыть Netlify → **Deploys**.
2. Найти предыдущий успешный деплой.
3. Нажать **Rollback to this deploy**.

Благодаря этому фронтенд быстро возвращается к рабочей версии.

---

## 6. Связанные документы

- `../ci_cd.md`
- `../environments.md`
- `../netlify_setup.md`
- `../cloudflare_setup.md`
- `../../architecture/fe_architecture.md`
