# Руководство по деплою backend-микросервисов Go2Asia

Этот документ описывает общий подход к деплою backend-сервисов Go2Asia.  
Конкретные команды и настройки зависят от выбранной инфраструктуры (Docker, облако и т.п.) и фиксируются в отдельных README сервисов.

---

## 1. Общие принципы

- Каждый микросервис разворачивается независимо.
- Конфигурация (URL БД, ключи, флаги) задаётся через переменные окружения.
- Деплой проходит через CI/CD (см. `../ci_cd.md`).
- Для production и staging используется отдельная инфраструктура/конфигурация.

---

## 2. Подготовка сервиса к деплою

Для любого сервиса (например, `atlas_service`):

1. Убедиться, что:
   - код в ветке `main`/`develop` актуален;
   - тесты проходят (`pnpm test` в директории сервиса);
   - сборка проходит (`pnpm build`).

2. Проверить конфигурацию:
   - `.env.example` содержит все необходимые переменные;
   - для staging/prod эти переменные заданы в CI/CD/облаке.

---

## 3. Сборка Docker-образа (если используется контейнеризация)

Примерный подход:

```bash
# в директории сервиса
docker build -t go2asia/atlas-service:TAG .
```

Где TAG:
- либо git-commit,
- либо версия релиза.

Далее:

```bash
docker push go2asia/atlas-service:TAG
```

(в реальности адрес registry будет конкретным — фиксируется в инфраструктурной документации).

---

## 4. Обновление сервиса в окружении

Зависит от используемой платформы (Kubernetes/VM/docker-compose). Общая схема:

1. Обновить конфигурацию деплоя:
   - образ `go2asia/atlas-service:TAG`,
   - переменные окружения (при необходимости).
2. Применить изменения:
   - `kubectl apply -f k8s/atlas-deployment.yaml`  
     или
   - перезапуск сервиса в docker-compose/на VM.

3. Проверить:
   - что новый pod/контейнер поднялся;
   - health-check endpoint отвечает;
   - логи не содержат критических ошибок.

---

## 5. Порядок деплоя при наличии зависимостей

Если изменения касаются нескольких сервисов:

1. **Схема данных (миграции БД)**:
   - сначала выполнить миграции в режиме, совместимом с обоими наборами кода (старым и новым);
2. **Сервисы ядра** (например, User/Auth, Points, Content):
   - обновлять в первую очередь при изменении контрактов;
3. **Дочерние сервисы/клиенты** (Atlas, Pulse, Blog и др.):
   - обновлять после ядра.

Подробные правила zero-downtime см. в `zero_downtime_updates.md`.

---

## 6. Деплой на staging

- Staging-сервисы используют отдельные БД/очереди/хранилища.
- Могут быть деплоены по merge в `develop`.
- Используются для:
  - финального тестирования,
  - проверок миграций и API-контрактов.

---

## 7. Деплой на production

- Триггер: merge в `main` и успешный CI.
- Деплой должен быть:
  - либо полностью автоматическим через CI/CD,
  - либо полуручным (подтверждение релиза), но строго по чек-листу.

Рекомендуется:

1. Деплой сервисов по одному (или по группам).
2. После каждого сервиса:
   - проверка health-check,
   - просмотр логов,
   - запуск минимального smoke-теста (запрос к ключевому endpoint-у).

---

## 8. Роллбэк backend-сервиса

Если после деплоя обнаружена критическая проблема:

1. Вернуть предыдущую версию образа/конфигурации.
2. Перезапустить сервис.
3. При необходимости — откатить БД-миграции (если они несовместимы назад; по возможности, миграции должны быть обратимыми).

---

## 9. Связанные документы

- `../ci_cd.md`
- `../environments.md`
- `../secrets_management.md`
- `zero_downtime_updates.md`
- `../../architecture/be_architecture.md`
- `../../architecture/microservices.md`
