# Zero-Downtime Updates — Обновления без простоя в Go2Asia

Этот документ описывает стратегии, механики и правила безопасных обновлений фронтенда и backend-микросервисов Go2Asia без остановки платформы.  
Zero-downtime — критически важное требование, так как Go2Asia является постоянно работающей экосистемой для путешественников, экспатов, партнёров и PRO-пользователей.

---

# 1. Основные принципы Zero Downtime

## 1.1. Недопустимость простоя
Платформа должна:
- обслуживать пользователей даже во время выката обновлений,
- обеспечивать согласованность данных,
- не ломать активные пользовательские сессии.

## 1.2. Совместимость версий
Новое приложение должно быть **совместимо со старым API**, а новый API — работать со старым фронтендом в течение переходного периода.

Золотое правило:

> **Сначала развёртывается backend (с backward-compatible контрактом), затем фронтенд.**

## 1.3. Релизы маленькими партиями
Чем меньше изменений в релизе, тем проще локализовать проблему без последствий.

## 1.4. Возможность мгновенного отката
Любое обновление должно иметь чёткий rollback-процедурный план.

---

# 2. Фронтенд (PWA) — Zero Downtime в Netlify + Cloudflare

PWA Go2Asia разворачивается на Netlify, что по умолчанию обеспечивает:

- предварительное построение нового билда,
- атомарное переключение на новую версию,
- отсутствие перерыва в обслуживании.

## 2.1. Процесс Zero Downtime в Netlify

1. Netlify собирает новый билд → в это время production работает на предыдущем билде.
2. После успешной сборки новый билд становится **активным**.
3. Предыдущий билд остаётся доступен для мгновенного отката.
4. Cloudflare продолжает обслуживать кешированные ресурсы без перерыва.

## 2.2. Рекомендации для фронтенда

- Не удалять старые API-методы сразу после релиза нового фронтенда.
- Использовать фиче-флаги для новых функций.
- По необходимости включать «мягкое обновление» → фронтенд подгружает новые данные без жёсткой перезагрузки.

---

# 3. Backend — Zero Downtime в микросервисной архитектуре

Backend состоит из множества микросервисов (User, Auth, Points, Atlas, Pulse, Blog, Quest и т.д.), и каждый из них может обновляться независимо.

Доступные стратегии:

- **Rolling Updates**
- **Blue-Green Deployment**
- **Canary Releases**

---

# 4. Rolling Updates (основная стратегия)

Если используется K8s или аналогичная система — применяется rolling update:

### Что происходит:

1. Поднимается новый экземпляр сервиса.
2. Он проходит health-check.
3. Только после успешного прогрева трафик начинает направляться на него.
4. Старые версии постепенно выключаются.

### Преимущества:

- нет единовременного переключения,
- автоматически поддерживается zero downtime,
- плавный переход между версиями.

---

# 5. Blue-Green Deployment (для критичных сервисов)

Применяется к сервисам:

- Auth Service,
- Blockchain Gateway,
- Points Service,
- Notification Service.

### Суть:

- Blue — текущая стабильная версия,
- Green — новая версия, работающая параллельно.

После полного тестирования Green → трафик переключается на неё одной операцией.

Если что-то пошло не так → мгновенный возврат на Blue.

---

# 6. Canary Deployment (опционально)

В canary-режиме новая версия получает только часть трафика (например, 5–10%).

Используется:

- для рискованных обновлений,
- для изменений логики начисления Points,
- для новых методов API.

Этапы:
- выкатывается canary,
- собираются метрики,
- если всё нормально → расширяем трафик на 100%,
- если есть ошибки → мгновенный откат.

---

# 7. Zero Downtime при миграциях БД

Миграции — главный источник возможных простоев.  
Стратегия Go2Asia:

## 7.1. «Сначала схема, потом код»

### Шаг 1. Выкатить миграцию схемы, совместимую со старым кодом:

- новые поля должны быть `nullable` или иметь безопасные `default`,
- старые поля ещё остаются в БД,
- индексы создаются заранее.

### Шаг 2. Обновить код микросервисов:

- сервисы начинают использовать новую схему,
- всё ещё совместимы со старой.

### Шаг 3. Фоновая миграция данных (если требуется):

- перенос данных из старых полей в новые,
- асинхронные задачи.

### Шаг 4. Удалить старую схему:

- только когда новый код 100% стабилен,
- когда все сервисы используют новую структуру.

## 7.2. Никогда не делать необратимые миграции сразу
Правильный подход:

- добавлять, а не удалять на первом этапе,
- менять структуру в несколько фаз,
- всегда иметь путь назад.

---

# 8. Zero Downtime при изменениях API

Чтобы избежать падений фронтенда или других сервисов:

## 8.1. Новую версию API вводить параллельно со старой
Например:

```
/api/v1/events
/api/v2/events
```

## 8.2. Старую версию не удалять немедленно
Минимум — 1 релизный цикл.

## 8.3. Фронтенд должен поддерживать обе версии, если необходимо
До полной миграции.

## 8.4. Контракты должны быть backward compatible
Большинство изменений должно происходить так, чтобы старые клиенты продолжали работать.

---

# 9. Feature Flags для безопасного включения функциональности

Фиче-флаги используются для:

- включения новых функций постепенно,
- тестирования на ограниченной группе,
- выключения проблемных фич мгновенно.

Способы хранения:

- локальная конфигурация сервиса,
- таблица в БД,
- отдельный Feature Flag Service (в будущем).

---

# 10. Мониторинг во время выката

Zero-downtime невозможен без мониторинга.

Сервис должен отслеживать:

- частоту ошибок (HTTP 5xx),
- ухудшение latency,
- ошибки клиента,
- падения новых pod,
- ошибки миграций,
- отклонения от нормы (аномалии трафика).

Любые всплески → сигнал к немедленному откату.

---

# 11. Процедура отката (Rollback) — единый стандарт Go2Asia

Если после выкатки сервис работает нестабильно:

## 11.1. Backend

1. Вернуть предыдущий Docker-образ / pod.
2. Перезапустить сервис.
3. Проверить health-check.
4. Если необходимо — откатить миграции БД (только обратимые!).

## 11.2. Frontend

В Netlify:

1. Открыть вкладку Deploys,
2. Выбрать предыдущий успешный deploy,
3. Нажать «Rollback to this deploy».

Откат мгновенный и безопасный.

---

# 12. Чек-лист Zero Downtime перед каждым релизом

### Backend:
- [ ] миграции совместимы с текущей версией,
- [ ] подготовлены fallback-механизмы,
- [ ] новые сервисы проходят health-check,
- [ ] мониторинг включён и настроен.

### Frontend:
- [ ] новые компоненты работают со старой API,
- [ ] нет удалённых API-методов, которые нужны старому коду,
- [ ] проведено тестирование в staging.

### Общий:
- [ ] есть чёткий rollback-план,
- [ ] все переменные окружения проверены,
- [ ] изменения задокументированы.

---

# 13. Связанные документы

- `backend_deploy.md`
- `frontend_deploy.md`
- `../ci_cd.md`
- `../monitoring.md`
- `../logging.md`
- `../../architecture/be_architecture.md`
- `../../architecture/caching_and_performance.md`
