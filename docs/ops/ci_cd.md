# CI/CD для Go2Asia

Этот документ описывает подход к непрерывной интеграции и доставке для фронтенда и backend-микросервисов Go2Asia.

---

## 1. Цели CI/CD

- Автоматическая проверка кода при каждом push/PR.
- Единый стандарт для фронтенда и микросервисов.
- Автоматический деплой в **Preview / Staging / Production**.
- Минимизация ручных действий при выкладке.

---

## 2. Общий подход

- Репозиторий: монорепо Go2Asia.
- Основные ветки:
  - `main` — production;
  - `develop` — staging;
  - feature-ветки `feature/*` — предварительная разработка.
- CI запускается:
  - при каждом push в любую ветку;
  - при создании/обновлении Pull Request.

---

## 3. Этапы CI

### 3.1. Lint & Typecheck

- Для фронтенда:
  - `pnpm lint`
  - `pnpm typecheck`
- Для сервисов:
  - `pnpm lint` в папке сервиса;
  - `pnpm test` (минимальный набор).

Условие: если lint/typecheck/tests не проходят — пайплайн останавливается.

---

### 3.2. Unit/Integration тесты

- Запускаются для модулей, в которых были изменения.
- Тесты:
  - unit-тесты (Jest/Vitest);
  - базовые интеграционные тесты.
- Тесты микросервисов могут использовать тестовую БД.

---

### 3.3. Сборка артефактов

- Фронтенд:
  - `pnpm build` (Next.js/PWA shell + модули).
- Backend-сервисы:
  - `pnpm build` в директории сервиса;
  - опционально — сборка Docker-образа.

---

## 4. Этапы CD (Deployment)

### 4.1. Preview окружения

Для Pull Request:

- Netlify создаёт **deploy preview** для фронтенда.
- Backend-сервисы могут поднимать временные инстансы (опционально) или использовать общую dev/staging БД.
- Ссылки на preview прикрепляются к PR.

### 4.2. Staging

Триггер: merge в ветку `develop`.

- Авто-деплой фронтенда в Netlify **staging-сайт**.
- Обновление нужных микросервисов в staging-окружении.
- Прогон smoke-тестов.

### 4.3. Production

Триггер: merge в ветку `main` + успешное прохождение CI.

- Авто-деплой фронтенда в Netlify **production-сайт**.
- Обновление микросервисов в prod.
- Нотификация (Slack/Email) о релизе.

---

## 5. Защита веток

- `main` и `develop` защищены:
  - нельзя пушить напрямую;
  - только через Pull Request;
  - минимальное количество ревью (1–2);
  - обязательный проход CI.

---

## 6. Роллбэки

- Для фронтенда:
  - Netlify позволяет быстро переключиться на предыдущий успешный билд.
- Для backend-сервисов:
  - хранение нескольких последних версий образов;
  - откат на предыдущую версию через интерфейс/скрипт деплоя.

---

## 7. Связанные документы

- `ops/environments.md`
- `ops/secrets_management.md`
- `ops/netlify_setup.md`
- `ops/cloudflare_setup.md`
- `architecture/be_architecture.md`
- `architecture/fe_architecture.md`
