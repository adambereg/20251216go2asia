# Netlify Setup — Настройка Netlify для фронтенда Go2Asia

Документ описывает, как развёртывается PWA Go2Asia на Netlify.

---

## 1. Роль Netlify

- Хостинг фронтенда (PWA shell + все модули).
- CI/CD для фронтенда.
- Preview-деплои для Pull Request.
- Управление переменными окружения для фронтенда.

---

## 2. Подключение репозитория

1. В Netlify создать новый сайт.
2. Подключить репозиторий (GitHub).
3. Выбрать основную ветку для production (обычно `main`).

---

## 3. Настройка сборки

- **Build command:**  
  `pnpm install --frozen-lockfile && pnpm build`
- **Publish directory:**  
  (в зависимости от фреймворка; для Next.js/SPA может отличаться, должно быть зафиксировано в README проекта).

Если используется Netlify Adapter для фреймворка — следовать рекомендациям из его документации.

---

## 4. Deploy Contexts (окружения)

Netlify поддерживает разные контексты:

- **Production** — деплой из ветки `main`.
- **Deploy Preview** — деплой для каждого PR.
- **Branch Deploys** — например, деплой из `develop` на `staging.go2asia.app`.

В `netlify.toml` могут быть заданы разные настройки в зависимости от контекста.

---

## 5. Переменные окружения

В Netlify настраиваются environment variables:

- API базовый URL (например, `NEXT_PUBLIC_API_BASE_URL`).
- Sentry/аналитика фронтенда (если используется).
- Feature flags (по необходимости).

Важно:
- всё, что начинается с `NEXT_PUBLIC_` / `VITE_` и т.п., будет доступно в браузере → не хранить там критичные секреты.

---

## 6. Связь с доменом

- В Netlify:
  - добавить custom domain `go2asia.app` / `www.go2asia.app` (или поддомен).
- На стороне Cloudflare:
  - CNAME-запись на Netlify.
- Проверить, что HTTPS работает корректно, трафик идёт через Cloudflare.

---

## 7. Логи и статистика

- В Netlify доступны логи билдов и деплоев.
- При ошибках сборки:
  - смотреть логи,
  - проверять версии Node, pnpm, переменные окружения.

---

## 8. Связанные документы

- `ops/ci_cd.md`
- `ops/environments.md`
- `ops/cloudflare_setup.md`
- `architecture/fe_architecture.md`

---

## 9. Интеграция Netlify с существующей инфраструктурой

На момент старта новой разработки фронтенд Go2Asia ещё только создаётся, но важна согласованность с уже настроенной инфраструктурой Cloudflare.

### 9.1. Принципы интеграции

1. **Единая DNS-зона: `go2asia.space`**
   - Домен управляется через Cloudflare.
   - Netlify-проекты (staging/production) подключаются к этой зоне через CNAME/ALIAS-записи.
   - Изменять DNS-записи напрямую в Netlify **нельзя** — только через Cloudflare.

2. **Netlify как origin для фронтенда**
   - Netlify-сайт деплоит статический/SSR-фронтенд.
   - Cloudflare остаётся «входной точкой» для домена и, при необходимости, может проксировать трафик.

3. **Переиспользование окружений**
   - При создании нового Netlify-сайта для Go2Asia желательно:
     - использовать **те же названия окружений**, что и в старом проекте (например, `G2A_STAGING`, `G2A_PROD`, если они уже есть),
     - сохранить схему переменных окружения (API_BASE_URL, CLERK_PUBLISHABLE_KEY и т.д.).
   - Все чувствительные значения задаются в Netlify UI, а в репозитории хранится только `.env.example`.

### 9.2. Правила для Cursor и DevOps

- Не создавать «новые» Netlify-сайты в коде или документации без согласования.
- В CI/CD (GitHub Actions) описывать только:
  - билд (`pnpm build` или `next build`);
  - deploy через Netlify CLI или GitHub–Netlify интеграцию.
- При изменении фронтенда:
  - не менять доменное имя (`go2asia.space` и связанные поддомены),
  - не трогать существующую Cloudflare-зону — она уже настроена.

Фронтенд Go2Asia должен органично вписываться в существующую схему:  
**Cloudflare DNS → Netlify frontend → Cloudflare / Workers backend.**
