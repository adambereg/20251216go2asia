# Secrets Management — Управление секретами в Go2Asia

Документ описывает, как хранятся и используются секреты (ключи, токены, пароли).

---

## 1. Принципы

- Никаких секретов в Git-репозитории.
- Использование `.env` только локально (и они всегда в `.gitignore`).
- В продакшн-окружениях — хранение через встроенные механизмы платформ (Netlify, Cloudflare и т.д.).
- Минимизация числа людей/сервисов, имеющих доступ к конкретным секретам (принцип наименьших привилегий).

---

## 2. Типы секретов

- Ключи к БД (PostgreSQL и др.).
- Ключи AI-провайдеров.
- Ключи внешних API (почтовые сервисы, платежи и др.).
- JWT-секреты и ключи подписи токенов.
- Секреты для отправки уведомлений (SMTP, API ключи пуш-сервисов).
- Внутренние сервисные ключи (например, для internal API между сервисами).

---

## 3. Локальная разработка

- Файл `.env.local` в корне проекта и/или в папках сервисов.
- `.env.local` внесён в `.gitignore` и **никогда не коммитится**.
- Шаблон: `.env.example` с перечнем переменных без значений.

---

## 4. Netlify (Frontend)

- Все секреты для фронтенда (например, публичные API endpoints, Sentry DSN) хранятся в **Environment variables** Netlify.
- Netlify поддерживает три типа окружений:
  - Deploy previews,
  - Branch deploys (например, `develop`),
  - Production.
- Для каждого окружения можно задать свои значения.

Важно:
- Не прокидывать чувствительные секреты напрямую на клиент (в браузер).
- Для truly-секретных операций использовать backend.

---

## 5. Backend-сервисы

В зависимости от платформы (Docker/Cloud/VPS):

- Используются:
  - переменные окружения (ENV),
  - Secret Manager соответствующего облака (если будет выбран).
- Секреты не попадают в Docker-образы (они подставляются при запуске).

---

## 6. Cloudflare

- Ключи/токены, необходимые для Cloudflare Workers/Pages/API, хранятся в:
  - Cloudflare Dashboard → Workers → Settings → Variables / Secrets.
- Ключи не должны находиться в коде репозитория.

---

## 7. Ротация секретов

- При утечке или подозрении на утечку — немедленная ревокация ключа и выдача нового.
- Периодическая плановая ротация для критичных секретов (JWT, БД).

---

## 8. Связанные документы

- `ops/environments.md`
- `ops/ci_cd.md`
- `ops/cloudflare_setup.md`
- `ops/netlify_setup.md`

---

## 9. Существующие интеграции и договорённости по именам секретов

Инфраструктура Go2Asia уже подключена к нескольким внешним сервисам: Cloudflare, Neon, Clerk, Netlify и др.  
Для переиспользования этих интеграций важно **сохранить имена секретов и переменных окружения**.

### 9.1. Группы секретов (GitHub / Netlify / Cloudflare / Neon / Clerk)

Рекомендуемый (и частично уже используемый) набор:

#### Cloudflare

- `CLOUDFLARE_ACCOUNT_ID` — ID аккаунта Cloudflare.
- `CLOUDFLARE_API_TOKEN` — API-токен с доступом к Workers, R2, DNS (минимально необходимые права).
- `CLOUDFLARE_R2_BUCKET` — имя бакета (`go2asia-media`).

#### Neon (PostgreSQL)

- `NEON_DATABASE_URL` или `DATABASE_URL` — строка подключения к базе Go2Asia (staging/prod).
- (Опционально) дополнительные переменные для read-only/replica, если будут.

#### Clerk

- `CLERK_PUBLISHABLE_KEY` — публичный ключ (может быть в `.env` и Netlify).
- `CLERK_SECRET_KEY` — секретный ключ (хранится только в GitHub/Netlify/Cloudflare Secrets).

#### Frontend / API

- `API_BASE_URL` — базовый URL API Gateway (например, `https://api.go2asia.space`).
- `AUTH_SERVICE_URL`, `CONTENT_SERVICE_URL`, `TOKEN_SERVICE_URL` — URL отдельных сервисов (по необходимости).

#### Прочие

- `SENTRY_DSN`, `POSTMARK_API_TOKEN`, `MAILGUN_API_KEY` и т.п. — по мере подключения сервисов.

### 9.2. Правила миграции в новый репозиторий

1. **Не менять имена ключевых переменных**, если в старых workflow’ах/окружениях они уже используются.  
   Это позволит:
   - подключить новый код к старой инфраструктуре,
   - избежать ручной перенастройки в Cloudflare/Neon/Clerk/Netlify.

2. **Хранить только `.env.example` в репозитории**
   - без значений, только с названиями переменных и комментариями;
   - реальные значения задаются в:
     - GitHub Secrets (CI/CD),
     - Netlify Environment Variables (frontend),
     - Cloudflare Workers Secrets (для runtime).

3. **Любое добавление нового секрета**:
   - фиксировать в этом документе,
   - добавлять в `.env.example`,
   - по возможности описывать в соответствующем модуле `docs/backend/*` или `docs/ops/environments.md`.

4. **Ротация секретов**
   - производится централизованно (например, сначала обновляются GitHub Secrets и Cloudflare/Netlify, затем — деплой),
   - не должна менять имена переменных, только значения.

### 9.3. Требования для Cursor и ИИ-агентов

- При генерации кода:
  - использовать уже существующие имена переменных (`CLOUDFLARE_ACCOUNT_ID`, `DATABASE_URL`, `CLERK_SECRET_KEY` и т.д.);
  - не придумывать новые схемы именования без ADR.
- При генерации GitHub Actions:
  - обращаться к секретам по существующим именам;
  - не пытаться «прокинуть» значения напрямую в YAML.

Таким образом, новый код и новые пайплайны **встраиваются** в уже настроенную инфраструктуру, а не создают параллельную.
