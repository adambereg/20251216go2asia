# Техническое задание MVP Go2Asia

**Версия:** 1.1 (доработанная)  
**Дата:** 2025-01-16  
**Автор:** Requirements Analyst  
**Статус:** Revised → на повторное ревью

---

## 1. Контекст и цели

### 1.1 Бизнес-контекст

Go2Asia — цифровая экосистема путешествий, жизни и бизнеса в Юго-Восточной Азии. MVP должен продемонстрировать базовую функциональность платформы и обеспечить минимально жизнеспособный продукт для первых пользователей.

### 1.2 Цели MVP

1. **Демонстрация концепции экосистемы** — показать интеграцию модулей и единое пространство данных
2. **Контентная база** — обеспечить доступ к справочной информации о локациях, событиях и статьях
3. **Базовая экономика** — запустить систему Points и простую реферальную программу
4. **Техническая готовность** — проверить архитектуру, инфраструктуру и процессы разработки

### 1.3 Ограничения MVP

- **Не входит в MVP:**
  - Полноценная социальная сеть (Space Asia)
  - Квесты и геймификация (Quest Asia)
  - Партнёрская программа (RF Asia)
  - Недвижимость (Rielt.Market)
  - Блокчейн-интеграция (on-chain NFT, G2A токены)
  - Guru Asia (агрегатор "рядом")
  - PRO-функции и кураторство

- **Входит в MVP:**
  - Atlas Asia (базовая версия)
  - Pulse Asia (базовая версия)
  - Blog Asia (базовая версия)
  - Connect Asia (баланс Points, реферальная программа)
  - Аутентификация (Clerk SSO)
  - Базовые микросервисы (Auth, Content, Points, Referral)

---

## 2. Роли пользователей MVP

### 2.1 Spacer (базовый пользователь)

**Как стать:** Регистрация через Clerk SSO

**Права и функции:**
- Просмотр контента (Atlas, Pulse, Blog)
- Регистрация на события (Pulse)
- Приглашение друзей через реферальную программу
- Получение Points за активность
- Просмотр баланса Points в Connect

**Ограничения:**
- Не может создавать контент
- Не может создавать события
- Не может создавать квесты

### 2.2 VIP-Spacer (активный пользователь)

**Как стать:** Достижение определённого уровня активности (например, 1000 Points или 5 приглашённых друзей)

**Права и функции:**
- Все права Spacer
- Повышенные коэффициенты начисления Points за активность рефералов
- Повышенные коэффициенты реферальных бонусов

**Ограничения MVP:**
- Не может создавать контент
- Не может создавать события
- Не открывает новых функциональных возможностей (только влияет на коэффициенты начисления Points)

### 2.3 Guest (неавторизованный пользователь)

**Права и функции:**
- Просмотр публичного контента (Atlas, Pulse, Blog)
- Регистрация через Clerk

**Ограничения:**
- Не может получать Points
- Не может участвовать в реферальной программе
- Не может регистрироваться на события

---

## 3. Модули MVP

### 3.1 Atlas Asia (MVP)

**Назначение:** Wiki-энциклопедия мест и локаций Юго-Восточной Азии

**Функциональность:**
- Просмотр стран, городов и мест
- Поиск по названию и категориям
- Фильтрация по типу места (достопримечательность, кафе, пляж и т.д.)
- Просмотр детальной информации о месте (описание, фото, координаты)
- Офлайн-доступ к последним просмотренным местам (кэширование через Service Worker)

**Стратегия офлайн-режима:**
- Последние 20 просмотренных мест кэшируются в IndexedDB
- При восстановлении соединения синхронизация не требуется (контент статический)
- Лимит кэширования: 50MB на устройство

**Ограничения MVP:**
- Нет редактирования контента пользователями (контент создаётся только администраторами)
- Нет рейтингов и отзывов
- Нет интеграции с картами (только координаты)
- CRUD операции доступны только администраторам через внутренний интерфейс

**User Stories:**
- Как путешественник, я хочу найти информацию о достопримечательностях Бангкока, чтобы спланировать маршрут
- Как экспат, я хочу узнать о районах города, чтобы выбрать место для жизни
- Как пользователь, я хочу сохранить информацию о месте для офлайн-доступа

### 3.2 Pulse Asia (MVP)

**Назначение:** Событийный календарь региона

**Функциональность:**
- Просмотр списка событий (календарь, лента)
- Фильтрация по дате (сегодня, завтра, неделя, месяц)
- Фильтрация по категории (фестиваль, встреча, экскурсия и т.д.)
- Просмотр детальной информации о событии (описание, время, место)
- Регистрация на событие (для авторизованных пользователей)
- Офлайн-доступ к ближайшим событиям (кэширование через Service Worker)

**Стратегия офлайн-режима:**
- Ближайшие события (на ближайшие 7 дней) кэшируются в IndexedDB
- При восстановлении соединения синхронизация не требуется (контент статический)
- Лимит кэширования: 50MB на устройство

**Ограничения MVP:**
- События создаются только администраторами
- Нет интеграции с организаторами
- Нет уведомлений о событиях
- Регистрация на событие хранится в БД (таблица event_registrations)
- Лимиты на количество участников не реализованы в MVP
- Отмена регистрации не реализована в MVP

**User Stories:**
- Как путешественник, я хочу узнать, какие события проходят в городе на этой неделе
- Как экспат, я хочу найти встречи сообщества, чтобы познакомиться с людьми
- Как пользователь, я хочу зарегистрироваться на событие, чтобы получить напоминание

### 3.3 Blog Asia (MVP)

**Назначение:** Медиаплатформа экосистемы

**Функциональность:**
- Просмотр списка статей (лента, категории)
- Фильтрация по категориям и тегам
- Просмотр детальной статьи (текст, фото, видео)
- Поиск по статьям
- SSR/SSG для SEO

**Ограничения MVP:**
- Статьи создаются только редакцией
- Нет inline-комментариев под статьями (без Disqus/Giscus). Обсуждение — social-first через репосты в Space.
- Интеграция с Space предполагается через репост статьи (обсуждение в контексте репоста), а не через inline-комментарии.

**User Stories:**
- Как путешественник, я хочу прочитать статьи о культуре и традициях региона
- Как экспат, я хочу найти полезные советы о жизни в Азии
- Как пользователь, я хочу поделиться статьёй в социальных сетях

### 3.4 Connect Asia (MVP)

**Назначение:** Центр экономики и мотивации пользователей

**Функциональность:**
- Просмотр баланса Points
- История транзакций Points
- Реферальная программа:
  - Генерация реферальной ссылки
  - Просмотр реферального дерева
  - Статистика приглашённых пользователей
- Базовые достижения (бейджи за активность)

**Ограничения MVP:**
- Нет конвертации Points в G2A
- Нет блокчейн-интеграции
- Бейджи являются виртуальными достижениями (UI-индикаторы)
- Бейджи хранятся в БД (таблица user_badges) и не имеют экономической или блокчейн-логики

**User Stories:**
- Как пользователь, я хочу видеть свой баланс Points и историю начислений
- Как пользователь, я хочу пригласить друзей и получить бонусы
- Как пользователь, я хочу видеть свои достижения и бейджи

---

## 4. Backend микросервисы MVP

### 4.1 Auth Service

**Назначение:** Управление пользователями и аутентификацией

**Функциональность:**
- Интеграция с Clerk SSO (вебхуки)
- Хранение профилей пользователей (дополнительные поля)
- Выдача JWT токенов для межсервисной авторизации
- Управление ролями (Spacer, VIP-Spacer)

**Интеграция с Clerk:**
- Используются webhooks: `user.created`, `user.updated`
- Auth Service принимает webhooks от Clerk через endpoint `/v1/auth/webhook/clerk`
- Clerk является единственным источником идентификации пользователей
- При обработке webhook `user.created` создаётся запись в БД с дополнительными полями (реферальный код, роль)
- При обработке webhook `user.updated` синхронизируются данные профиля
- Ошибки вебхуков логируются, но не блокируют работу системы

**API Endpoints (базовые):**
- `GET /v1/auth/profile` — получение профиля пользователя
- `POST /v1/auth/webhook/clerk` — приём вебхуков от Clerk
- `GET /v1/auth/roles` — получение ролей пользователя

**Примечание:** Детальные API спецификации описываются в `docs/openapi/*.yaml` согласно OpenAPI-first процессу (см. ENGINEERING_PLAYBOOK.md).

### 4.2 Content Service

**Назначение:** Единая точка доступа к контенту (Atlas, Pulse, Blog)

**Функциональность:**
- CRUD операции для мест (Atlas) — только для администраторов через внутренний интерфейс
- CRUD операции для событий (Pulse) — только для администраторов через внутренний интерфейс
- CRUD операции для статей (Blog) — только для администраторов через внутренний интерфейс
- Публичное чтение контента (GET endpoints)
- Поиск и фильтрация
- Кэширование публичного контента

**Доступ к CRUD операциям:**
- Пользовательский UGC в MVP отсутствует
- Все операции создания/редактирования/удаления доступны только администраторам
- Администраторы используют минимальную админ-панель для создания контента

**API Endpoints (базовые):**
- `GET /v1/content/places` — список мест (публичный)
- `GET /v1/content/places/{id}` — детали места (публичный)
- `GET /v1/content/events` — список событий (публичный)
- `GET /v1/content/events/{id}` — детали события (публичный)
- `GET /v1/content/articles` — список статей (публичный)
- `GET /v1/content/articles/{slug}` — детали статьи (публичный)
- POST/PUT/DELETE endpoints доступны только администраторам (описываются в OpenAPI)

**Примечание:** Детальные API спецификации описываются в `docs/openapi/*.yaml` согласно OpenAPI-first процессу (см. ENGINEERING_PLAYBOOK.md).

### 4.3 Points Service

**Назначение:** Управление системой Points

**Функциональность:**
- Начисление Points за активность согласно правилам (см. таблицу ниже)
- Списание Points (не используется в MVP)
- История транзакций
- Баланс пользователя
- Идемпотентность транзакций (предотвращение дублирования начислений)

**Правила начисления Points (MVP):**

| Действие | Points | Ограничения |
|---------|--------|-------------|
| Регистрация | 100 | 1 раз |
| Регистрация по реферальной ссылке | 200 | 1 раз |
| Первый вход в систему | 50 | 1 раз |
| Регистрация на событие | 20 | не чаще 1 раза в день |
| Активный реферал (первый вход) | 100 | за каждого реферала |

**Ограничения:**
- Начисление происходит через Points Service
- Все начисления логируются в таблице transactions
- Velocity checks предотвращают злоупотребления (максимум 1000 Points в час на пользователя)

**API Endpoints (базовые):**
- `GET /v1/points/balance` — баланс Points (публичный для авторизованных)
- `GET /v1/points/transactions` — история транзакций (публичный для авторизованных)
- `POST /v1/points/add` — начисление Points (внутренний API, вызывается другими сервисами)
- `POST /v1/points/subtract` — списание Points (внутренний API, не используется в MVP)

**Примечание:** Детальные API спецификации описываются в `docs/openapi/*.yaml` согласно OpenAPI-first процессу (см. ENGINEERING_PLAYBOOK.md).

### 4.4 Referral Service

**Назначение:** Реферальная программа

**Функциональность:**
- Генерация реферальных кодов/ссылок для каждого пользователя
- Отслеживание реферальных связей (таблица referral_links)
- Статистика рефералов (количество, активность)
- Начисление бонусов за рефералов через Points Service

**Логика реферальной программы (MVP):**
- При регистрации нового пользователя по реферальной ссылке:
  - Создаётся связь между реферером и рефералом
  - Реферал получает 200 Points (вместо 100 за обычную регистрацию)
  - Реферер получает 100 Points за активного реферала (при первом входе реферала)
- Для VIP-Spacer: повышенные коэффициенты реферальных бонусов (детали в post-MVP)
- Многоуровневая реферальная система (2+ уровня) не реализована в MVP

**API Endpoints (базовые):**
- `GET /v1/referral/code` — получение реферального кода (для авторизованных)
- `GET /v1/referral/tree` — реферальное дерево (для авторизованных)
- `GET /v1/referral/stats` — статистика рефералов (для авторизованных)
- `POST /v1/referral/register` — регистрация по реферальной ссылке (публичный, но требует реферальный код)

**Примечание:** Детальные API спецификации описываются в `docs/openapi/*.yaml` согласно OpenAPI-first процессу (см. ENGINEERING_PLAYBOOK.md).

### 4.5 API Gateway

**Назначение:** Единая точка входа для всех API запросов

**Функциональность:**
- Маршрутизация запросов к микросервисам
- Аутентификация (проверка JWT)
- Rate limiting
- Кэширование публичных запросов
- Логирование запросов

**API Endpoints:**
- `GET /health` — health check
- `GET /ready` — readiness check
- Все маршруты `/v1/*` проксируются к соответствующим сервисам

---

## 5. Frontend архитектура MVP

### 5.1 PWA Shell (App Shell)

**Технологии:** Next.js 15 (App Router), React, Tailwind CSS

**Функциональность:**
- Общий layout (header, navigation, footer)
- Маршрутизация модулей
- Интеграция Clerk SSO
- Service Worker для офлайн-режима
- PWA Manifest

**Структура:**
```
apps/go2asia-pwa-shell/
├── app/
│   ├── (public)/          # Публичные страницы
│   │   ├── atlas/
│   │   ├── pulse/
│   │   └── blog/
│   ├── (authenticated)/   # Защищённые страницы
│   │   └── connect/
│   └── layout.tsx
├── components/            # Общие компоненты
├── lib/                   # Утилиты
└── styles/                # Глобальные стили
```

### 5.2 Feature Capsules

Каждый модуль реализуется как **Feature Capsule** — изолированный модуль с чёткими границами (см. FRONTEND_PLAYBOOK.md):

- `features/atlas-ui/` — компоненты и хуки Atlas
- `features/pulse-ui/` — компоненты и хуки Pulse
- `features/blog-ui/` — компоненты и хуки Blog
- `features/connect-ui/` — компоненты и хуки Connect

**Правила изоляции:**
- Feature Capsule может импортировать только из `packages/`
- Feature Capsule НЕ может импортировать из других Feature Capsules
- Общение между Capsules только через общие пакеты или через backend API

### 5.3 Shared Packages

- `packages/ui/` — UI компоненты (Button, Card, Badge и т.д.)
- `packages/sdk/` — автогенерируемый API клиент
- `packages/types/` — автогенерируемые типы из OpenAPI
- `packages/design-system/` — дизайн-токены

---

## 6. User Stories MVP

### 6.1 Atlas Asia

**US-ATLAS-001:** Как путешественник, я хочу просмотреть список стран Юго-Восточной Азии, чтобы выбрать направление для поездки.

**US-ATLAS-002:** Как пользователь, я хочу найти все кафе в Бангкоке, чтобы выбрать место для работы.

**US-ATLAS-003:** Как экспат, я хочу узнать о районах города, чтобы выбрать место для жизни.

**US-ATLAS-004:** Как пользователь, я хочу сохранить информацию о месте для офлайн-доступа.

### 6.2 Pulse Asia

**US-PULSE-001:** Как путешественник, я хочу узнать, какие события проходят в городе на этой неделе.

**US-PULSE-002:** Как экспат, я хочу найти встречи сообщества, чтобы познакомиться с людьми.

**US-PULSE-003:** Как пользователь, я хочу зарегистрироваться на событие, чтобы получить напоминание.

**US-PULSE-004:** Как пользователь, я хочу фильтровать события по категориям (фестиваль, встреча, экскурсия).

### 6.3 Blog Asia

**US-BLOG-001:** Как путешественник, я хочу прочитать статьи о культуре и традициях региона.

**US-BLOG-002:** Как экспат, я хочу найти полезные советы о жизни в Азии.

**US-BLOG-003:** Как пользователь, я хочу поделиться статьёй в социальных сетях.

**US-BLOG-004:** Как пользователь, я хочу найти статьи по тегам и категориям.

### 6.4 Connect Asia

**US-CONNECT-001:** Как пользователь, я хочу видеть свой баланс Points и историю начислений.

**US-CONNECT-002:** Как пользователь, я хочу пригласить друзей и получить бонусы.

**US-CONNECT-003:** Как пользователь, я хочу видеть свои достижения и бейджи.

**US-CONNECT-004:** Как пользователь, я хочу видеть статистику моих рефералов.

### 6.5 Аутентификация

**US-AUTH-001:** Как новый пользователь, я хочу зарегистрироваться через социальные сети, чтобы быстро начать пользоваться платформой.

**US-AUTH-002:** Как пользователь, я хочу войти в систему один раз и иметь доступ ко всем модулям.

**US-AUTH-003:** Как пользователь, я хочу видеть свой профиль и настройки.

---

## 7. Non-functional Requirements

### 7.1 Производительность

- **Время загрузки:** Первая загрузка страницы < 3 секунд (Lighthouse Performance ≥ 85)
- **API Response Time:** p95 latency < 500ms для публичных GET запросов
- **Кэширование:** Публичный контент кэшируется на Edge (TTL 600 секунд)

### 7.2 Безопасность

- **Аутентификация:** Clerk SSO с JWT токенами
- **Авторизация:** Проверка ролей на уровне API Gateway
- **Rate Limiting:** 100 req/min для публичных GET, 10 req/min для POST
- **Валидация:** Все входные данные валидируются через Zod схемы

### 7.3 Доступность

- **PWA:** Работа в офлайн-режиме для просмотренного контента
- **Mobile-first:** Адаптивный дизайн для мобильных устройств
- **SEO:** SSR/SSG для публичных страниц (Atlas, Pulse, Blog)

### 7.4 Масштабируемость

- **Микросервисы:** Независимое масштабирование каждого сервиса
- **CDN:** Статика раздаётся через Cloudflare CDN
- **База данных:** Neon PostgreSQL с возможностью горизонтального масштабирования

### 7.5 Наблюдаемость

- **Логирование:** Структурированные логи с requestId для трассировки
- **Метрики:** Cloudflare Analytics для мониторинга производительности
- **Health Checks:** `/health` и `/ready` endpoints для всех сервисов

---

## 8. Критерии приёмки MVP

### 8.1 Функциональные критерии

- ✅ Пользователь может просматривать контент в Atlas, Pulse, Blog
- ✅ Пользователь может зарегистрироваться и войти через Clerk SSO
- ✅ Пользователь может видеть баланс Points и историю транзакций
- ✅ Пользователь может пригласить друзей через реферальную программу
- ✅ Пользователь может зарегистрироваться на событие в Pulse
- ✅ Публичный контент доступен в офлайн-режиме

### 8.2 Технические критерии

- ✅ Все микросервисы развёрнуты и доступны
- ✅ API Gateway маршрутизирует запросы корректно
- ✅ OpenAPI спецификация актуальна и типы генерируются автоматически
- ✅ CI/CD pipeline работает (lint, typecheck, build, deploy)
- ✅ Health checks всех сервисов возвращают 200 OK
- ✅ Логирование и метрики настроены

### 8.3 UX критерии

- ✅ Навигация между модулями интуитивна
- ✅ Страницы загружаются быстро (< 3 секунд)
- ✅ Дизайн адаптивен для мобильных устройств
- ✅ Ошибки обрабатываются корректно (error boundaries, fallback UI)

---

## 9. Ограничения и риски

### 9.1 Технические ограничения

- **Контент:** На этапе MVP контент может быть частично захардкожен или импортирован из внешних источников
- **Модерация:** Контент модерируется вручную администраторами
- **Интеграции:** Нет интеграции с внешними сервисами (карты, платежи и т.д.)

### 9.2 Риски

- **Недостаток контента:** Риск отсутствия достаточного количества контента для демонстрации функциональности
- **Производительность:** Риск медленной загрузки при большом объёме данных
- **Безопасность:** Риск утечек данных при неправильной настройке JWT и авторизации

### 9.3 Митигация рисков

- Подготовить seed данные для демонстрации функциональности (см. раздел 11)
- Настроить кэширование и оптимизацию запросов
- Провести security review перед релизом

---

## 11. Seed данные для MVP

Для демонстрации функциональности MVP необходимы следующие seed данные:

### 11.1 Требования к seed данным

**Atlas (места):**
- 7 стран Юго-Восточной Азии (Таиланд, Вьетнам, Индонезия, Малайзия, Сингапур, Филиппины, Камбоджа)
- 10–15 городов (по 2–3 города на страну)
- 30–50 мест (достопримечательности, кафе, пляжи, районы)
- Каждое место должно содержать: название, описание, координаты, категорию, фото

**Pulse (события):**
- 10–15 событий на ближайшие 30 дней
- Разнообразие категорий (фестиваль, встреча, экскурсия, концерт)
- Каждое событие должно содержать: название, описание, дату/время, место проведения (связь с Atlas), категорию

**Blog (статьи):**
- 10 статей на различные темы (культура, путешествия, лайфстайл, digital-nomad опыт)
- Каждая статья должна содержать: заголовок, slug, описание, текст, категорию, теги, автора, дату публикации, обложку

### 11.2 Формат seed данных

- Seed данные хранятся в SQL файлах в директории `services/content-service/seeds/`
- Файлы должны быть в кодировке UTF-8
- Seed данные должны быть идемпотентными (можно запускать многократно)
- Проверка кодировки выполняется в CI (см. ENGINEERING_PLAYBOOK.md)

### 11.3 Админ-панель для создания контента

**Минимальная админ-панель (MVP):**
- Внутренний интерфейс для администраторов
- Функции:
  - Создание/редактирование мест (Atlas)
  - Создание/редактирование событий (Pulse)
  - Создание/редактирование статей (Blog)
- Доступ: только для администраторов (роль определяется через Auth Service)
- Реализация: простая форма с валидацией, сохранение через Content Service API

---

## 10. Зависимости

### 10.1 Внешние зависимости

- **Clerk:** SSO провайдер (уже настроен)
- **Neon PostgreSQL:** База данных (уже настроена)
- **Cloudflare:** CDN, Workers, R2 (уже настроено)
- **Netlify:** Хостинг фронтенда (уже настроен)

### 10.2 Внутренние зависимости

- **Phase 0:** Должна быть завершена перед началом MVP
- **OpenAPI-first:** Все API должны быть описаны в OpenAPI перед реализацией
- **Design System:** UI компоненты должны быть готовы перед разработкой модулей

### 10.3 Зависимости между сервисами (MVP)

**Схема зависимостей:**

```
API Gateway
├── → Auth Service (JWT валидация, роли)
├── → Content Service (публичный контент)
├── → Points Service (баланс, транзакции)
└── → Referral Service (реферальная программа)

Referral Service
├── → Auth Service (идентификация пользователя)
└── → Points Service (начисление бонусов)

Points Service
└── (не зависит от других сервисов напрямую)
```

**Типы взаимодействий:**
- **Синхронные:** HTTP REST API через API Gateway
- **Асинхронные:** Не используются в MVP (event-driven архитектура отложена на post-MVP)

**Последовательность инициализации:**
1. Auth Service (должен быть доступен для проверки JWT)
2. Points Service (независимый сервис)
3. Referral Service (зависит от Auth и Points)
4. Content Service (независимый сервис)
5. API Gateway (зависит от всех сервисов)

---

## Deliverables

- ✅ ТЗ MVP доработано согласно замечаниям ревьюера
- ✅ Добавлены правила начисления Points (таблица)
- ✅ Уточнена роль VIP-Spacer (только коэффициенты, без новых функций)
- ✅ Уточнена реализация бейджей (виртуальные достижения, хранятся в БД)
- ✅ Уточнён доступ к CRUD операциям (только администраторы)
- ✅ Добавлены зависимости между сервисами
- ✅ Добавлена интеграция с Clerk (webhooks)
- ✅ Добавлены требования к seed данным
- ✅ Добавлено описание админ-панели (минимально)
- ✅ Уточнена логика регистрации на события
- ✅ Уточнена стратегия офлайн-режима
- ✅ Уточнена логика реферальной программы

## Open Questions

Все открытые вопросы решены в доработанной версии ТЗ:
1. ✅ Контент создаётся только администраторами через админ-панель
2. ✅ События в Pulse только публичные (создаются администраторами)
3. ✅ Интеграция с внешними картами не требуется (достаточно координат)
4. ✅ Бейджи — виртуальные достижения (UI-индикаторы), хранятся в БД

## Next

Передача управления агенту **TZ Reviewer** для повторного ревью доработанного ТЗ MVP.

