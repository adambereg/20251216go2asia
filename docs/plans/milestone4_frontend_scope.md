# Milestone 4: Frontend MVP — Scope & Requirements

**Версия:** 1.0  
**Дата:** 2025-12-19  
**Автор:** Requirements Analyst (Frontend M4)  
**Статус:** Draft → на ревью

---

## 1. Scope M4 (минимум UI)

### 1.1. Обязательные экраны

#### 1.1.1. Login / Auth
- **Цель:** Минимальная интеграция с текущей схемой аутентификации
- **Требования:**
  - Использовать существующую интеграцию Clerk (если настроена)
  - Если Clerk не настроен — использовать текущую реализацию проекта
  - После успешного входа — редирект на `/connect` (Dashboard)
- **API:** Не требуется (Clerk обрабатывает auth)
- **Состояния:**
  - Loading (во время проверки сессии)
  - Error (неверные credentials, сетевые ошибки)

#### 1.1.2. Profile / Dashboard (`/connect`)
- **Цель:** Показать базовую информацию пользователя и баланс Points
- **Требования:**
  - Отобразить `userId` / имя (если доступно через Clerk)
  - Отобразить текущий баланс Points (`GET /v1/points/balance`)
  - Отобразить referral code / referral link (`GET /v1/referral/code`)
  - Показать последние транзакции (`GET /v1/points/transactions`, limit=10)
- **API endpoints:**
  - `GET /v1/points/balance` (через gateway)
  - `GET /v1/points/transactions` (через gateway)
  - `GET /v1/referral/code` (через gateway)
- **Состояния:**
  - Loading (скелетон или спиннер)
  - Empty (нет транзакций)
  - Error (401/403, 500, network)

#### 1.1.3. Events Register (минимальный экран/форма)
- **Цель:** Регистрация на событие через API Gateway
- **Требования:**
  - Форма с полями (если нужны): eventId (из URL), дополнительные поля (если требуются API)
  - Вызов `POST /v1/content/events/{id}/register` через gateway
  - После успешной регистрации:
    - Показать toast/notification об успехе
    - Обновить баланс Points (refetch)
    - Показать результат (например, "Вы зарегистрированы на событие X")
- **API endpoints:**
  - `POST /v1/content/events/{id}/register` (через gateway)
- **Состояния:**
  - Loading (кнопка disabled, спиннер)
  - Success (toast + обновление баланса)
  - Error (409 конфликт — уже зарегистрирован, 401/403, 500, network)

### 1.2. Обязательные UX-состояния

#### Loading
- Скелетоны для списков (транзакции, события)
- Спиннеры для кнопок/форм
- Минимальное время показа: 300ms (чтобы избежать мерцания)

#### Empty
- Пустые состояния для:
  - Нет транзакций
  - Нет событий
  - Нет referral code (если ещё не создан)

#### Error
- **Network errors:** "Проверьте подключение к интернету"
- **401 Unauthorized:** Редирект на `/sign-in` с `redirect_url`
- **403 Forbidden:** "У вас нет доступа к этому ресурсу"
- **409 Conflict:** "Вы уже зарегистрированы на это событие"
- **5xx:** "Произошла ошибка сервера. Попробуйте позже"
- **Toast/notification:** Показывать ошибки через toast (react-hot-toast или аналог)

---

## 2. User Flows

### 2.1. Flow: Вход → Профиль → Points → Referral → Событие Register

```
1. Пользователь открывает приложение
   → Проверка сессии (Clerk middleware)
   → Если не авторизован → редирект на `/sign-in`

2. Пользователь входит через Clerk
   → После успешного входа → редирект на `/connect`

3. На странице `/connect` (Dashboard):
   → Загружается баланс Points (`GET /v1/points/balance`)
   → Загружается referral code (`GET /v1/referral/code`)
   → Загружаются последние транзакции (`GET /v1/points/transactions`)
   → Отображается userId/имя (из Clerk)

4. Пользователь видит referral code
   → Может скопировать referral link
   → Может поделиться ссылкой

5. Пользователь переходит на событие (например, `/pulse/{id}`)
   → Видит кнопку "Зарегистрироваться"
   → Нажимает кнопку
   → Вызывается `POST /v1/content/events/{id}/register`
   → Показывается loading состояние
   → После успеха:
     - Toast: "Вы успешно зарегистрированы!"
     - Обновляется баланс Points (refetch)
     - Кнопка меняется на "Вы зарегистрированы" (disabled)
```

### 2.2. Flow: Негативные сценарии

#### Сценарий 1: Неавторизованный доступ
```
Пользователь пытается открыть `/connect`
→ Middleware проверяет сессию
→ Редирект на `/sign-in?redirect_url=/connect`
```

#### Сценарий 2: Ошибка сети при загрузке баланса
```
Пользователь на `/connect`
→ `GET /v1/points/balance` возвращает network error
→ Показывается toast: "Проверьте подключение к интернету"
→ Показывается fallback UI (можно показать мок-данные или пустое состояние)
```

#### Сценарий 3: Конфликт при регистрации на событие
```
Пользователь пытается зарегистрироваться на событие
→ `POST /v1/content/events/{id}/register` возвращает 409 Conflict
→ Показывается toast: "Вы уже зарегистрированы на это событие"
→ Кнопка меняется на "Вы зарегистрированы" (disabled)
```

#### Сценарий 4: 401 при запросе баланса
```
Пользователь на `/connect`
→ `GET /v1/points/balance` возвращает 401
→ Редирект на `/sign-in?redirect_url=/connect`
→ После входа → возврат на `/connect`
```

---

## 3. Acceptance Criteria

### 3.1. Функциональные критерии

#### AC-1: Login / Auth
- ✅ Пользователь может войти через Clerk (если настроен)
- ✅ После входа происходит редирект на `/connect`
- ✅ Неавторизованные пользователи редиректятся на `/sign-in`
- ✅ Ошибки входа отображаются пользователю

#### AC-2: Profile / Dashboard
- ✅ Отображается userId/имя пользователя (из Clerk)
- ✅ Отображается текущий баланс Points (из API)
- ✅ Отображается referral code (из API)
- ✅ Отображаются последние 10 транзакций (из API)
- ✅ При ошибке загрузки показывается соответствующее сообщение
- ✅ При отсутствии данных показывается empty state

#### AC-3: Events Register
- ✅ Пользователь может зарегистрироваться на событие через форму/кнопку
- ✅ После успешной регистрации показывается toast об успехе
- ✅ После успешной регистрации обновляется баланс Points
- ✅ При конфликте (409) показывается соответствующее сообщение
- ✅ При ошибке (401/403/500) показывается соответствующее сообщение

### 3.2. Технические критерии

#### AC-4: API Integration
- ✅ Все API-вызовы идут через gateway (`NEXT_PUBLIC_API_URL`)
- ✅ Все запросы содержат `X-Request-Id` header
- ✅ Все авторизованные запросы содержат JWT токен (через Clerk)
- ✅ Ошибки API обрабатываются корректно (401 → редирект, 409 → конфликт, 5xx → ошибка сервера)

#### AC-5: UX States
- ✅ Loading состояния показываются для всех асинхронных операций
- ✅ Empty states показываются для пустых списков
- ✅ Error states показываются для всех типов ошибок
- ✅ Toast/notifications показываются для успешных операций и ошибок

### 3.3. Негативные сценарии (обязательные проверки)

#### NC-1: Network Errors
- ✅ При network error показывается сообщение "Проверьте подключение к интернету"
- ✅ При network error можно повторить запрос (retry button)

#### NC-2: Authentication Errors
- ✅ При 401 происходит редирект на `/sign-in` с `redirect_url`
- ✅ При 403 показывается сообщение "У вас нет доступа"

#### NC-3: Conflict Errors
- ✅ При 409 показывается сообщение о конфликте (например, "Вы уже зарегистрированы")
- ✅ UI обновляется соответственно (кнопка disabled, статус изменён)

#### NC-4: Server Errors
- ✅ При 5xx показывается сообщение "Произошла ошибка сервера. Попробуйте позже"
- ✅ При 5xx можно повторить запрос (retry button)

---

## 4. Non-Goals (что НЕ входит в M4)

### 4.1. Не входит в M4
- ❌ Полноценный модуль Atlas (только интеграция с событиями)
- ❌ Полноценный модуль Pulse (только регистрация на события)
- ❌ Полноценный модуль Blog
- ❌ Офлайн-режим (Service Worker, IndexedDB)
- ❌ PWA Manifest (уже есть базовая версия)
- ❌ Полноценная реферальная программа (только показ кода и ссылки)
- ❌ История транзакций с пагинацией (только последние 10)
- ❌ Фильтрация/поиск транзакций
- ❌ Административные функции
- ❌ Настройки профиля (редактирование)
- ❌ Уведомления (push notifications)

### 4.2. Что будет в следующих милстоунах
- M5: Полноценные модули (Atlas, Pulse, Blog)
- M5: Офлайн-режим
- M5: Расширенная реферальная программа
- M6+: Дополнительные функции

---

## 5. Зависимости

### 5.1. Backend (уже готово в M3)
- ✅ API Gateway развёрнут и доступен
- ✅ Points Service развёрнут (`GET /v1/points/balance`, `GET /v1/points/transactions`)
- ✅ Referral Service развёрнут (`GET /v1/referral/code`)
- ✅ Content Service развёрнут (`POST /v1/content/events/{id}/register`)
- ✅ Auth Service развёрнут (интеграция с Clerk)

### 5.2. Frontend Infrastructure (уже готово)
- ✅ Next.js 15 PWA Shell настроен
- ✅ Clerk интеграция настроена (базовая)
- ✅ SDK генерируется из OpenAPI
- ✅ React Query настроен
- ✅ Design System компоненты доступны

---

## 6. Риски и митигация

### Риск 1: SDK не генерируется корректно из OpenAPI
- **Вероятность:** Средняя
- **Влияние:** Высокое
- **Митигация:** Проверить генерацию SDK перед началом реализации, использовать мок-данные как fallback

### Риск 2: Gateway URL не настроен корректно
- **Вероятность:** Низкая
- **Влияние:** Высокое
- **Митигация:** Проверить `NEXT_PUBLIC_API_URL` в staging, добавить `.env.example`

### Риск 3: Clerk токены не передаются в API запросах
- **Вероятность:** Средняя
- **Влияние:** Высокое
- **Митигация:** Проверить интеграцию Clerk с SDK, добавить логирование токенов (только в dev)

---

## 7. Метрики успеха

### 7.1. Функциональные метрики
- ✅ Все обязательные экраны работают
- ✅ Все обязательные UX-состояния реализованы
- ✅ Все негативные сценарии обработаны

### 7.2. Технические метрики
- ✅ Все API-вызовы идут через gateway
- ✅ Все запросы содержат необходимые headers
- ✅ Ошибки обрабатываются корректно

---

## 8. Gate Review

**Gate A (Requirements Analyst):** ✅ **APPROVED**

**Комментарии:**
- Scope чётко определён
- User flows описаны
- Acceptance criteria конкретны
- Non-goals ясны

**Следующий этап:** Gate B (UX/UI Reviewer)

---

**Дата создания:** 2025-12-19  
**Последнее обновление:** 2025-12-19

